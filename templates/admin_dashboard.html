{% extends 'base.html' %}

{% block title %}Admin Dashboard - SixGents 6-Mans{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="content-container">
        <div class="content-header">
            <h2><i class="fas fa-shield-alt me-2"></i> Admin Dashboard</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="exportData()">
                    <i class="fas fa-download me-1"></i> Export
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card primary">
                    <div class="stat-card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-value" id="totalVerifications">-</div>
                    <div class="stat-card-title">Total Verifications</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card secondary">
                    <div class="stat-card-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-card-value" id="rankACount">-</div>
                    <div class="stat-card-title">Rank A Players</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card accent">
                    <div class="stat-card-icon">
                        <i class="fas fa-medal"></i>
                    </div>
                    <div class="stat-card-value" id="rankBCount">-</div>
                    <div class="stat-card-title">Rank B Players</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card primary">
                    <div class="stat-card-icon">
                        <i class="fas fa-award"></i>
                    </div>
                    <div class="stat-card-value" id="rankCCount">-</div>
                    <div class="stat-card-title">Rank C Players</div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">
                        <label for="searchUser" class="form-label">Search Player</label>
                        <input type="text" class="form-control" id="searchUser" placeholder="Discord username or ID">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filterRank" class="form-label">Filter by Rank</label>
                        <select class="form-select" id="filterRank">
                            <option value="">All Ranks</option>
                            <option value="Rank A">Rank A</option>
                            <option value="Rank B">Rank B</option>
                            <option value="Rank C">Rank C</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="sortBy" class="form-label">Sort By</label>
                        <select class="form-select" id="sortBy">
                            <option value="timestamp">Recent Verifications</option>
                            <option value="mmr">MMR (High to Low)</option>
                            <option value="matches">Most Active</option>
                            <option value="username">Username A-Z</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verifications Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Rank Verifications</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="width: 300px">Discord User</th>
                                <th style="width: 400px">Verified Rank</th>
                                <th style="width: 150px">Verified Date</th>
                                <th style="width: 80px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="verificationsTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading verification data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted" id="paginationInfo">
                        Showing 0 of 0 results
                    </div>
                    <nav aria-label="Verification pagination">
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- Pagination buttons will be inserted here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let confirmModal;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modal
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // Load initial data
    loadStats();
    loadVerifications();

    // Set up search functionality
    document.getElementById('searchUser').addEventListener('input', debounce(applyFilters, 500));
});

function loadStats() {
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading stats:', data.error);
                return;
            }

            document.getElementById('totalVerifications').textContent = data.total_verifications || 0;
            document.getElementById('rankACount').textContent = data.rank_a_verifications || 0;
            document.getElementById('rankBCount').textContent = data.rank_b_verifications || 0;
            document.getElementById('rankCCount').textContent = data.rank_c_verifications || 0;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function loadVerifications(page = 1) {
    currentPage = page;

    // Build query parameters
    const params = new URLSearchParams({
        page: page,
        ...currentFilters
    });

    fetch(`/api/admin/rank-verifications?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError('Failed to load verification data: ' + data.error);
                return;
            }

            displayVerifications(data.verifications);
            updatePagination(data.pagination);
        })
        .catch(error => {
            console.error('Error loading verifications:', error);
            showError('Failed to load verification data');
        });
}

function displayVerifications(verifications) {
    const tbody = document.getElementById('verificationsTableBody');

    if (verifications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <p class="mb-0">No verifications found</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = verifications.map(verification => {
        const tierBadge = getTierBadge(verification.tier);

        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fw-semibold">${verification.discord_username || 'Unknown'}</div>
                            <small class="text-muted">ID: ${verification.discord_id || ''}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center gap-3">
                        ${tierBadge}
                        <span class="text-muted">${verification.rank || 'N/A'}</span>
                    </div>
                </td>
                <td>
                    <small class="text-muted">${verification.verified_date || 'Unknown'}</small>
                </td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" onclick="viewPlayerDetails('${verification.discord_id}')">
                                    <i class="fas fa-eye me-2"></i> View Details
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="confirmDeleteVerification('${verification.discord_id}', '${verification.discord_username}')">
                                    <i class="fas fa-trash me-2"></i> Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination(pagination) {
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationContainer = document.getElementById('pagination');

    // Update info text
    const start = ((pagination.page - 1) * pagination.per_page) + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    paginationInfo.textContent = `Showing ${start}-${end} of ${pagination.total} results`;

    // Generate pagination buttons
    let paginationHTML = '';

    // Previous button
    if (pagination.page > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadVerifications(${pagination.page - 1})">Previous</a>
            </li>
        `;
    } else {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
    }

    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);

    if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadVerifications(1)">1</a></li>`;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.page) {
            paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadVerifications(${i})">${i}</a></li>`;
        }
    }

    if (endPage < pagination.pages) {
        if (endPage < pagination.pages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadVerifications(${pagination.pages})">${pagination.pages}</a></li>`;
    }

    // Next button
    if (pagination.page < pagination.pages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadVerifications(${pagination.page + 1})">Next</a>
            </li>
        `;
    } else {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
    }

    paginationContainer.innerHTML = paginationHTML;
}

function getTierBadge(tier) {
    const badges = {
        'Rank A': '<span class="badge bg-danger">Rank A</span>',
        'Rank B': '<span class="badge bg-primary">Rank B</span>',
        'Rank C': '<span class="badge bg-success">Rank C</span>'
    };
    return badges[tier] || '<span class="badge bg-secondary">Unknown</span>';
}

// Removed getPlatformIcon since we don't need platform info anymore

function applyFilters() {
    currentFilters = {};

    const searchUser = document.getElementById('searchUser').value.trim();
    const filterRank = document.getElementById('filterRank').value;
    const sortBy = document.getElementById('sortBy').value;

    if (searchUser) currentFilters.search = searchUser;
    if (filterRank) currentFilters.rank = filterRank;
    if (sortBy) currentFilters.sort = sortBy;

    loadVerifications(1);
}

function refreshData() {
    loadStats();
    loadVerifications(currentPage);
}

function exportData() {
    // Create CSV data from current table
    const rows = document.querySelectorAll('#verificationsTableBody tr');
    let csvContent = "Discord Username,Verified Rank,Tier,Verified Date\n";

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 1) { // Skip loading/empty rows
            const rowData = [
                cells[0].textContent.trim().split('\n')[0], // Discord username
                cells[1].textContent.trim().split('\n')[1] || '', // Rank text
                cells[1].textContent.trim().split('\n')[0] || '', // Tier from badge
                cells[2].textContent.trim()
            ];
            csvContent += rowData.map(field => `"${field}"`).join(',') + '\n';
        }
    });

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rank_verifications_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function viewPlayerDetails(playerId) {
    // Use the existing player modal function
    if (typeof showPlayerDetails === 'function') {
        showPlayerDetails(playerId);
    } else {
        console.error('Player details function not available');
    }
}

function confirmDeleteVerification(discordId, username) {
    document.getElementById('confirmModalBody').innerHTML = `
        <p>Are you sure you want to delete the rank verification for <strong>${username}</strong>?</p>
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            This action cannot be undone. The user will need to verify their rank again.
        </div>
    `;

    document.getElementById('confirmActionBtn').onclick = function() {
        deleteVerification(discordId);
    };

    confirmModal.show();
}

function deleteVerification(discordId) {
    fetch(`/api/admin/rank-verification/${discordId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            confirmModal.hide();
            showSuccess('Rank verification deleted successfully');
            loadStats();
            loadVerifications(currentPage);
        } else {
            showError('Failed to delete verification: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error deleting verification:', error);
        showError('Failed to delete verification');
    });
}

function showSuccess(message) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function showError(message) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 8000);
}

// Utility function for debouncing search input
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}