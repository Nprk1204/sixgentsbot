{% extends "base.html" %}

{% block title %}Rocket League 6 Gents - Player Profile{% endblock %}

{% block extra_css %}
<!-- Add any extra CSS needed for the profile page -->
<style>
    .profile-container {
        min-height: 80vh;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <div class="content-header">
        <h2>Player Profile</h2>
    </div>

    <!-- React app will be mounted here -->
    <div id="player-profile-app" class="profile-container">
        <div class="text-center py-5">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Loading profile...</span>
            </div>
            <p class="mt-3">Loading player profile...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- React and ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Babel for JSX -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Your React component -->
<script type="text/babel">
const { useState, useEffect } = React;

const PlayerProfile = () => {
  // State for user authentication
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState('');

  // State for player data
  const [playerData, setPlayerData] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [activeTab, setActiveTab] = useState('stats');

  // State for queue status
  const [queueStatus, setQueueStatus] = useState({
    inQueue: false,
    channel: '',
    players: 0,
    totalPlayers: 6
  });

  // Check for existing session on load
  useEffect(() => {
    checkSession();
  }, []);

  // Function to check if user is already logged in
  const checkSession = () => {
    setIsLoading(true);

    // In a real app, make a fetch request to check session
    // For demo purposes, we'll check the template variables
    {% if logged_in %}
    setIsLoggedIn(true);
    setUsername("{{ username }}");
    fetchPlayerData();
    {% else %}
    setIsLoading(false);
    {% endif %}
  };

  // Login function - will call the real API
  const handleLogin = () => {
    setIsLoading(true);

    // Make an actual fetch request to our API
    fetch('/api/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ username, password }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        setIsLoggedIn(true);
        fetchPlayerData();
        setLoginError('');
      } else {
        setLoginError(data.message || 'Login failed');
        setIsLoading(false);
      }
    })
    .catch(error => {
      setLoginError('An error occurred during login. Please try again.');
      setIsLoading(false);
    });
  };

  // Fetch player data from the API
  const fetchPlayerData = () => {
    setIsLoading(true);
    setError(null);

    fetch('/api/profile')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch profile data');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          setPlayerData(data.player);
          setQueueStatus(data.queue_status);
        } else {
          setError(data.message || 'Failed to load profile data');
        }
        setIsLoading(false);
      })
      .catch(error => {
        setError(error.message);
        setIsLoading(false);
      });
  };

  // Function to handle logout
  const handleLogout = () => {
    fetch('/api/logout', {
      method: 'POST',
    })
    .then(() => {
      setIsLoggedIn(false);
      setUsername('');
      setPassword('');
      setPlayerData(null);
    })
    .catch(error => {
      console.error('Logout error:', error);
    });
  };

  // Rest of component functions from your original code
  // renderLoginForm()
  // renderPlayerStats()
  // renderQueueStatus()
  // renderMatchHistory()
  // renderRankInfo()
  // renderProfile()

  // Paste all your rendering functions here from the original code
  const renderLoginForm = () => {
    return (
      <div className="bg-dark-medium p-4 rounded-lg shadow-lg">
        <h2 className="text-xl font-bold mb-4 text-center">Login to Your Profile</h2>

        {loginError && (
          <div className="bg-red-900 text-white p-3 rounded mb-4">
            {loginError}
          </div>
        )}

        <div>
          <div className="mb-4">
            <label className="block text-sm font-medium mb-1">Discord Username</label>
            <input
              type="text"
              className="w-full bg-dark text-white border border-gray-700 rounded p-2 focus:border-primary focus:outline-none"
              placeholder="Enter your Discord username"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
            />
            <p className="text-sm text-gray-400 mt-1">
              This should match your Discord server username
            </p>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium mb-1">Password</label>
            <input
              type="password"
              className="w-full bg-dark text-white border border-gray-700 rounded p-2 focus:border-primary focus:outline-none"
              placeholder="Enter password (optional demo)"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
            <p className="text-sm text-gray-400 mt-1">
              For demo purposes, any password will work
            </p>
          </div>

          <div className="mt-6">
            <button
              onClick={handleLogin}
              className="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2 px-4 rounded transition duration-200"
              disabled={isLoading}
            >
              {isLoading ? (
                <span className="flex items-center justify-center">
                  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Logging in...
                </span>
              ) : (
                'Login'
              )}
            </button>
          </div>
        </div>

        <div className="mt-4 text-center">
          <p className="text-sm text-gray-400">
            This is a demo. In a real application, this would connect to the 6 Gents Discord bot's
            authentication system.
          </p>
        </div>
      </div>
    );
  };

  // IMPORTANT: Add all the other functions from your paste.txt file here
  // renderPlayerStats, renderQueueStatus, renderMatchHistory, etc.

  // For brevity, I'm not pasting all of them, but you should include ALL of them

  // The final return statement from your component
  return (
    <div className="container mx-auto max-w-4xl p-4">
      {isLoggedIn ? renderProfile() : renderLoginForm()}
    </div>
  );
};

// Mount the React component to the DOM
ReactDOM.createRoot(document.getElementById('player-profile-app')).render(<PlayerProfile />);
</script>
{% endblock %}