{% extends "base.html" %}

{% block title %}Rocket League 6 Gents - Rank Check{% endblock %}

{% block content %}
<div class="content-container">
    <div class="content-header">
        <h2>Rocket League Rank Check</h2>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card bg-dark-medium mb-4">
                <div class="card-body">
                    <h4 class="mb-3">How It Works</h4>
                    <p>Select your current Rocket League competitive rank from the dropdown and get assigned the appropriate Discord role and starting MMR in our 6 Gents system.</p>

                    <h5 class="mt-4">Step 1: Select Your Rank</h5>
                    <p>Choose your competitive 3v3 rank from the dropdown menu.</p>

                    <h5 class="mt-3">Step 2: One-Click Verification</h5>
                    <p>Click the verify button to automatically receive the appropriate Discord role and starting MMR.</p>

                    <h5 class="mt-3">Step 3: Role Assignment</h5>
                    <p>You'll receive the appropriate Discord role and starting MMR based on your selected rank.</p>
                </div>
            </div>

            <div class="card bg-dark-medium">
                <div class="card-header">
                    <h4 class="mb-0">Select Your Rank</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="rlRank" class="form-label">Your Rocket League 3v3 Rank</label>
                        <select class="form-select" id="rlRank">
                            <option value="" selected disabled>Select your 3v3 competitive rank</option>

                            <!-- Rank C -->
                            <optgroup label="Rank C">
                                <!-- Bronze -->
                                <option value="bronze_1" data-mmr="50" data-tier="Rank C">Bronze I</option>
                                <option value="bronze_2" data-mmr="100" data-tier="Rank C">Bronze II</option>
                                <option value="bronze_3" data-mmr="150" data-tier="Rank C">Bronze III</option>

                                <!-- Silver -->
                                <option value="silver_1" data-mmr="200" data-tier="Rank C">Silver I</option>
                                <option value="silver_2" data-mmr="225" data-tier="Rank C">Silver II</option>
                                <option value="silver_3" data-mmr="250" data-tier="Rank C">Silver III</option>

                                <!-- Gold -->
                                <option value="gold_1" data-mmr="300" data-tier="Rank C">Gold I</option>
                                <option value="gold_2" data-mmr="325" data-tier="Rank C">Gold II</option>
                                <option value="gold_3" data-mmr="350" data-tier="Rank C">Gold III</option>

                                <!-- Platinum -->
                                <option value="platinum_1" data-mmr="400" data-tier="Rank C">Platinum I</option>
                                <option value="platinum_2" data-mmr="425" data-tier="Rank C">Platinum II</option>
                                <option value="platinum_3" data-mmr="450" data-tier="Rank C">Platinum III</option>

                                <!-- Diamond -->
                                <option value="diamond_1" data-mmr="500" data-tier="Rank C">Diamond I</option>
                                <option value="diamond_2" data-mmr="550" data-tier="Rank C">Diamond II</option>
                                <option value="diamond_3" data-mmr="600" data-tier="Rank C">Diamond III</option>
                            </optgroup>

                            <!-- Rank B -->
                            <optgroup label="Rank B">
                                <!-- Champion -->
                                <option value="champion_1" data-mmr="700" data-tier="Rank B">Champion I</option>
                                <option value="champion_2" data-mmr="800" data-tier="Rank B">Champion II</option>
                                <option value="champion_3" data-mmr="900" data-tier="Rank B">Champion III</option>

                                <!-- Grand Champion -->
                                <option value="grand_champion_1" data-mmr="1100" data-tier="Rank B">Grand Champion I</option>
                            </optgroup>

                            <!-- Rank A -->
                            <optgroup label="Rank A">
                                <option value="grand_champion_2" data-mmr="1300" data-tier="Rank A">Grand Champion II</option>
                                <option value="grand_champion_3" data-mmr="1450" data-tier="Rank A">Grand Champion III</option>
                                <option value="ssl" data-mmr="1600" data-tier="Rank A">Supersonic Legend</option>
                            </optgroup>
                        </select>
                        <div id="rankPreview" class="mt-3 text-center d-none">
                            <img id="rankImage" src="" alt="Rank Icon" class="img-fluid mb-2" style="max-width: 80px;">
                            <h5 id="rankName" class="mb-0"></h5>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="discordUsername" class="form-label">Discord Username for role assignment</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fab fa-discord"></i></span>
                            <input type="text" class="form-control" id="discordUsername" placeholder="e.g., Display name or account name" value="">
                        </div>
                        <small class="form-text text-muted">Your Discord username as shown in the server</small>
                    </div>

                    <div class="d-grid">
                        <button type="button" id="verifyRankButton" class="btn btn-primary">
                            <i class="fas fa-check-circle me-2"></i> Verify My Rank
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mt-4 mt-lg-0">
            <h4 class="mb-3">Rank Tiers & Starting MMR</h4>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="rank-card">
                        <div class="rank-header rank-a">
                            <i class="fas fa-trophy fa-2x"></i>
                        </div>
                        <div class="rank-body">
                            <h5 class="rank-title">Rank A</h5>
                            <p class="rank-description">Grand Champion II & Above</p>
                            <p class="rank-mmr">Starting MMR: 1600</p>
                            <span class="badge bg-danger">Rank A Role</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="rank-card">
                        <div class="rank-header rank-b">
                            <i class="fas fa-award fa-2x"></i>
                        </div>
                        <div class="rank-body">
                            <h5 class="rank-title">Rank B</h5>
                            <p class="rank-description">Champion I to Grand Champion I</p>
                            <p class="rank-mmr">Starting MMR: 1100</p>
                            <span class="badge bg-primary">Rank B Role</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="rank-card">
                        <div class="rank-header rank-c">
                            <i class="fas fa-medal fa-2x"></i>
                        </div>
                        <div class="rank-body">
                            <h5 class="rank-title">Rank C</h5>
                            <p class="rank-description">Diamond III and below</p>
                            <p class="rank-mmr">Starting MMR: 600</p>
                            <span class="badge bg-success">Rank C Role</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-dark-medium mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Verification Result</h5>
                </div>
                <div class="card-body" id="verificationResult">
                    <p class="text-center text-muted">Select your Rocket League rank and click "Verify My Rank" to see your results</p>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i> Please select your highest 3v3 competitive rank. Accurate rank selection ensures fair matchmaking for everyone.
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Rank Verification Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultModalContent">
                <!-- Results will be shown here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalButton">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const verifyRankButton = document.getElementById('verifyRankButton');
        const rlRankSelect = document.getElementById('rlRank');
        const rankPreview = document.getElementById('rankPreview');
        const rankImage = document.getElementById('rankImage');
        const rankName = document.getElementById('rankName');
        let resultModal;

        // Initialize the modal
        if (document.getElementById('resultModal')) {
            resultModal = new bootstrap.Modal(document.getElementById('resultModal'), {
                backdrop: 'static',
                keyboard: true
            });
        }

        // Check if rank verification has already been done
        checkVerificationStatus();

        // Setup the rank preview when selecting a rank
        rlRankSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const rankValue = this.value;

            if (rankValue) {
                // Show the rank preview
                rankPreview.classList.remove('d-none');

                // Set the rank image
                rankImage.src = `/static/img/ranks/${rankValue}.png`;

                // Set the rank name
                rankName.textContent = selectedOption.textContent;
            } else {
                // Hide the preview if no rank is selected
                rankPreview.classList.add('d-none');
            }
        });

        // Check for leaderboard resets
        checkForLeaderboardReset();

        // Check for existing rank data
        checkForExistingRankData();

        // Set up reset listener for active sessions
        setupResetListener();

        // Handle rank verification
        if (verifyRankButton) {
            verifyRankButton.addEventListener('click', function() {
                verifyRank();
            });
        }

        function checkVerificationStatus() {
            // Check if rank is already verified
            if (localStorage.getItem('rankVerified') === 'true') {
                updateButtonToVerified();
            }
        }

        function updateButtonToVerified() {
            const verifyRankButton = document.getElementById('verifyRankButton');
            if (verifyRankButton) {
                verifyRankButton.disabled = true;
                verifyRankButton.innerHTML = `<i class="fas fa-check-circle me-2"></i> Rank Already Verified`;
                verifyRankButton.classList.remove('btn-primary');
                verifyRankButton.classList.add('btn-info');

                // Remove any event listeners by replacing the button
                const newButton = verifyRankButton.cloneNode(true);
                verifyRankButton.parentNode.replaceChild(newButton, verifyRankButton);
            }
        }

        function resetButtonState() {
            const verifyRankButton = document.getElementById('verifyRankButton');
            if (verifyRankButton) {
                verifyRankButton.disabled = false;
                verifyRankButton.innerHTML = `<i class="fas fa-check-circle me-2"></i> Verify My Rank`;
                verifyRankButton.classList.remove('btn-info');
                verifyRankButton.classList.add('btn-primary');

                // Reattach click event
                const newButton = verifyRankButton.cloneNode(true);
                newButton.addEventListener('click', function() {
                    verifyRank();
                });
                verifyRankButton.parentNode.replaceChild(newButton, verifyRankButton);
            }
        }

        function verifyRank() {
            const rlRankSelect = document.getElementById('rlRank');
            const discordUsername = document.getElementById('discordUsername').value.trim();

            if (!rlRankSelect.value) {
                alert('Please select your Rocket League rank');
                return;
            }

            if (!discordUsername) {
                alert('Please enter your Discord username for verification');
                return;
            }

            // Get the selected rank details
            const selectedOption = rlRankSelect.options[rlRankSelect.selectedIndex];
            const rankTier = selectedOption.getAttribute('data-tier');
            const startingMMR = selectedOption.getAttribute('data-mmr');
            const rankName = selectedOption.textContent;
            const rankValue = rlRankSelect.value;

            // Show loading state
            document.getElementById('verificationResult').innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your rank verification...</p>
                </div>
            `;

            // Disable the button while processing
            const verifyRankButton = document.getElementById('verifyRankButton');
            verifyRankButton.disabled = true;
            verifyRankButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Verifying...
            `;

            // Simulate API call with a timeout (replace with actual API call if needed)
            setTimeout(() => {
                // Create a data object to store the verification result
                const data = {
                    username: discordUsername,
                    rank: rankName,
                    tier: rankTier,
                    mmr: startingMMR,
                    rankValue: rankValue,
                    success: true
                };

                // Store the rank data for persistence
                localStorage.setItem('rankCheckData', JSON.stringify(data));
                localStorage.setItem('rankVerified', 'true');

                // Display results
                displayRankResults(data);

                // Update button
                updateButtonToVerified();
            }, 1500); // Simulate a 1.5s API call
        }

        // Function to check if leaderboard has been reset
        function checkForLeaderboardReset() {
            console.log('Checking for leaderboard resets...');

            fetch('/api/reset-timestamp')
                .then(response => response.json())
                .then(data => {
                    console.log('Reset check response:', data);

                    if (data.success && data.last_reset) {
                        console.log('Server reports last reset at:', data.last_reset);

                        // Get stored reset timestamp
                        const lastCheckedReset = localStorage.getItem('lastCheckedReset');

                        // Clear verification data on page load if reset happened
                        if (!lastCheckedReset || new Date(data.last_reset) > new Date(lastCheckedReset)) {
                            console.log('New reset detected! Clearing all rank data...');

                            // Clear ALL verification data
                            localStorage.removeItem('rankCheckData');
                            localStorage.removeItem('rankVerified');

                            // Update the last checked timestamp
                            localStorage.setItem('lastCheckedReset', data.last_reset);

                            // Force UI to reset immediately
                            resetButtonState();

                            // Clear verification result
                            document.getElementById('verificationResult').innerHTML = `
                                <p class="text-center text-muted">Select your Rocket League rank and click "Verify My Rank" to see your results</p>
                            `;

                            // Show reset notification if this isn't the first visit
                            if (lastCheckedReset) {
                                const alertHtml = `
                                    <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Leaderboard Reset!</strong> The leaderboard has been reset. Please verify your rank again.
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                `;
                                document.querySelector('.content-header').insertAdjacentHTML('afterend', alertHtml);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking for leaderboard reset:', error);
                });
        }

        // Set up a listener for resets during an active session
        function setupResetListener() {
            // Poll for reset events every 30 seconds
            setInterval(function() {
                fetch('/api/reset-timestamp')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.last_reset) {
                            const lastCheckedReset = localStorage.getItem('lastCheckedReset');

                            if (lastCheckedReset && new Date(data.last_reset) > new Date(lastCheckedReset)) {
                                console.log('Reset detected during session! Refreshing page...');

                                // Display alert before refresh
                                alert("The leaderboard has been reset. This page will refresh.");

                                // Clear localStorage
                                localStorage.removeItem('rankCheckData');
                                localStorage.removeItem('rankVerified');
                                localStorage.setItem('lastCheckedReset', data.last_reset);

                                // Reload the page
                                window.location.reload();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error in reset listener:', error);
                    });
            }, 30000); // Check every 30 seconds
        }

        // Function to check for existing rank data
        function checkForExistingRankData() {
            // Try to get stored rank data from localStorage
            const storedRankData = localStorage.getItem('rankCheckData');

            if (storedRankData && localStorage.getItem('rankVerified') === 'true') {
                try {
                    const rankData = JSON.parse(storedRankData);
                    // Display the verification result with stored data
                    displayStoredRankResult(rankData);

                    // Ensure the button is in verified state
                    updateButtonToVerified();
                } catch (e) {
                    console.error('Error parsing stored rank data:', e);
                    // Clear invalid data
                    localStorage.removeItem('rankCheckData');
                    localStorage.removeItem('rankVerified');
                }
            }
        }

        // Function to display stored rank result
        function displayStoredRankResult(data) {
            // Create a rank card based on tier
            let rankCard = createRankCardForTier(data.tier);

            // Create verification result display
            let resultHtml = `
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i> Rank verification successful!
                </div>

                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <img src="/static/img/ranks/${data.rankValue}.png" alt="${data.rank}" class="img-fluid" style="width: 50px;">
                    </div>
                    <div>
                        <h6 class="mb-0">Your Verified Rank</h6>
                        <p class="mb-0">${data.rank}</p>
                    </div>
                </div>

                <p>Please check the modal for details or <a href="#" id="showStoredRankDetails">click here</a> to view details.</p>

                ${rankCard}
            `;

            document.getElementById('verificationResult').innerHTML = resultHtml;

            // Add event listener to show details
            document.getElementById('showStoredRankDetails').addEventListener('click', function(e) {
                e.preventDefault();
                showRankDetails(data);
            });

            // Set the rank dropdown to the stored value if it exists
            if (data.rankValue && document.getElementById('rlRank')) {
                document.getElementById('rlRank').value = data.rankValue;

                // Trigger the change event to update the preview
                const event = new Event('change');
                document.getElementById('rlRank').dispatchEvent(event);
            }

            // Set the Discord username
            if (data.username && document.getElementById('discordUsername')) {
                document.getElementById('discordUsername').value = data.username;
            }
        }

        function displayRankResults(data) {
            // Create appropriate rank card based on tier
            let rankCard = createRankCardForTier(data.tier);

            // Create verification result display
            let resultHtml = `
                <div class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i> Rank verification successful!
                </div>

                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <img src="/static/img/ranks/${data.rankValue}.png" alt="${data.rank}" class="img-fluid" style="width: 50px;">
                    </div>
                    <div>
                        <h6 class="mb-0">Your Verified Rank</h6>
                        <p class="mb-0">${data.rank}</p>
                    </div>
                </div>

                <p>Please check the modal for details or <a href="#" id="showRankDetails">click here</a> to view details.</p>

                ${rankCard}
            `;

            document.getElementById('verificationResult').innerHTML = resultHtml;

            // Add event listener to show details button
            document.getElementById('showRankDetails').addEventListener('click', function(e) {
                e.preventDefault();
                showRankDetails(data);
            });

            // Show the modal
            showRankDetails(data);
        }

        // Function to show detailed rank information in modal
        function showRankDetails(data) {
            // Create modal content
            let modalContent = `
                <div class="text-center">
                    <div class="mb-3">
                        <img src="/static/img/ranks/${data.rankValue}.png" alt="${data.rank}" class="img-fluid" style="max-width: 80px;">
                    </div>
                    <h4>Your rank has been verified!</h4>
                    <p class="mb-3">${data.rank}</p>

                    <div class="alert alert-info">
                        <strong>Discord Role:</strong> ${data.tier}<br>
                        <strong>Starting MMR:</strong> ${data.mmr}
                    </div>

                    <p>You can now join the 6 Gents queue in the Discord server.</p>
                </div>
            `;

            document.getElementById('resultModalContent').innerHTML = modalContent;

            // Show the modal
            if (resultModal) {
                resultModal.show();
            }
        }

        // Create a rank card HTML based on tier
        function createRankCardForTier(tier) {
            let rankColor, rankTitle, rankDescription, mmrValue;

            // Set values based on tier
            if (tier === "Rank A") {
                rankColor = "rank-a";
                rankTitle = "Rank A";
                rankDescription = "Grand Champion II & Above";
                mmrValue = "1600";
            } else if (tier === "Rank B") {
                rankColor = "rank-b";
                rankTitle = "Rank B";
                rankDescription = "Champion I to Grand Champion I";
                mmrValue = "1100";
            } else {
                rankColor = "rank-c";
                rankTitle = "Rank C";
                rankDescription = "Diamond III and below";
                mmrValue = "600";
            }

            // Generate HTML for rank card
            return `
                <div class="rank-card">
                    <div class="rank-header ${rankColor}">
                        <i class="fas fa-trophy fa-2x"></i>
                    </div>
                    <div class="rank-body">
                        <h5 class="rank-title">${rankTitle}</h5>
                        <p class="rank-description">${rankDescription}</p>
                        <p class="rank-mmr">Starting MMR: ${mmrValue}</p>
                        <span class="badge bg-${getBadgeColor(tier)}">${tier} Role</span>
                    </div>
                </div>
            `;
        }

        // Utility function to get badge color based on tier
        function getBadgeColor(tier) {
            const colors = {
                'Rank A': 'danger',
                'Rank B': 'primary',
                'Rank C': 'success'
            };

            return colors[tier] || 'secondary';
        }
    });
</script>
{% endblock %}