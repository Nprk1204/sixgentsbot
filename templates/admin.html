{% extends 'base.html' %}

{% block title %}Admin Dashboard - SixGents 6-Mans{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="content-container">
        <div class="content-header">
            <h2><i class="fas fa-shield-alt me-2"></i> Admin Dashboard</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card primary">
                    <div class="stat-card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-value" id="totalVerifications">-</div>
                    <div class="stat-card-title">Total Verifications</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card secondary">
                    <div class="stat-card-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-card-value" id="rankACount">-</div>
                    <div class="stat-card-title">Rank A Players</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card accent">
                    <div class="stat-card-icon">
                        <i class="fas fa-medal"></i>
                    </div>
                    <div class="stat-card-value" id="rankBCount">-</div>
                    <div class="stat-card-title">Rank B Players</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card primary">
                    <div class="stat-card-icon">
                        <i class="fas fa-award"></i>
                    </div>
                    <div class="stat-card-value" id="rankCCount">-</div>
                    <div class="stat-card-title">Rank C Players</div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">
                        <label for="searchUser" class="form-label">Search Player</label>
                        <input type="text" class="form-control" id="searchUser" placeholder="Discord username or ID">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filterRank" class="form-label">Filter by Rank</label>
                        <select class="form-select" id="filterRank">
                            <option value="">All Ranks</option>
                            <option value="Rank A">Rank A</option>
                            <option value="Rank B">Rank B</option>
                            <option value="Rank C">Rank C</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="sortBy" class="form-label">Sort By</label>
                        <select class="form-select" id="sortBy">
                            <option value="timestamp">Recent Verifications</option>
                            <option value="mmr">MMR (High to Low)</option>
                            <option value="matches">Most Active</option>
                            <option value="username">Username A-Z</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verifications Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Rank Verifications</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="width: 300px">Discord User</th>
                                <th style="width: 400px">Verified Rank</th>
                                <th style="width: 150px">Verified Date</th>
                                <th style="width: 80px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="verificationsTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Loading verification data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted" id="paginationInfo">
                        Showing 0 of 0 results
                    </div>
                    <nav aria-label="Verification pagination">
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- Pagination buttons will be inserted here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Player Details Modal -->
<div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playerModalLabel">Player Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="playerModalContent">
                <!-- Player details will be loaded here -->
                <div class="text-center">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading player data...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};
let confirmModal;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modal
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // Load initial data
    loadStats();
    loadVerifications();

    // Set up search functionality
    document.getElementById('searchUser').addEventListener('input', debounce(applyFilters, 500));
});

function loadStats() {
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading stats:', data.error);
                return;
            }

            document.getElementById('totalVerifications').textContent = data.total_verifications || 0;
            document.getElementById('rankACount').textContent = data.rank_a_verifications || 0;
            document.getElementById('rankBCount').textContent = data.rank_b_verifications || 0;
            document.getElementById('rankCCount').textContent = data.rank_c_verifications || 0;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function loadVerifications(page = 1) {
    currentPage = page;

    // Build query parameters for the API
    const params = new URLSearchParams({
        page: page,
        ...currentFilters
    });

    fetch(`/api/admin/rank-verifications?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError('Failed to load verification data: ' + data.error);
                return;
            }

            displayVerifications(data.verifications);
            updatePagination(data.pagination);
        })
        .catch(error => {
            console.error('Error loading verifications:', error);
            showError('Failed to load verification data');
        });
}

function displayVerifications(verifications) {
    const tbody = document.getElementById('verificationsTableBody');

    if (verifications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <p class="mb-0">No verifications found</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = verifications.map(verification => {
        const tierBadge = getTierBadge(verification.tier);

        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fw-semibold">${verification.discord_username || 'Unknown'}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center gap-3">
                        ${tierBadge}
                    </div>
                </td>
                <td>
                    <small class="text-muted">${verification.verified_date ? verification.verified_date.split(' ')[0] : 'Unknown'}</small>
                </td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" onclick="viewPlayerDetails('${verification.discord_id}')">
                                    <i class="fas fa-eye me-2"></i> View Details
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="confirmDeleteVerification('${verification.discord_id}', '${verification.discord_username}')">
                                    <i class="fas fa-trash me-2"></i> Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination(pagination) {
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationContainer = document.getElementById('pagination');

    // Update info text
    const start = ((pagination.page - 1) * pagination.per_page) + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    paginationInfo.textContent = `Showing ${start}-${end} of ${pagination.total} results`;

    // Generate pagination buttons
    let paginationHTML = '';

    // Previous button
    if (pagination.page > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadVerifications(${pagination.page - 1})">Previous</a>
            </li>
        `;
    } else {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
    }

    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);

    if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadVerifications(1)">1</a></li>`;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.page) {
            paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadVerifications(${i})">${i}</a></li>`;
        }
    }

    if (endPage < pagination.pages) {
        if (endPage < pagination.pages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadVerifications(${pagination.pages})">${pagination.pages}</a></li>`;
    }

    // Next button
    if (pagination.page < pagination.pages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadVerifications(${pagination.page + 1})">Next</a>
            </li>
        `;
    } else {
        paginationHTML += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
    }

    paginationContainer.innerHTML = paginationHTML;
}

function getTierBadge(tier) {
    const badges = {
        'Rank A': '<span class="badge bg-danger">Rank A</span>',
        'Rank B': '<span class="badge bg-primary">Rank B</span>',
        'Rank C': '<span class="badge bg-success">Rank C</span>'
    };
    return badges[tier] || '<span class="badge bg-secondary">Unknown</span>';
}

function applyFilters() {
    const searchUser = document.getElementById('searchUser').value.trim();
    const filterRank = document.getElementById('filterRank').value;
    const sortBy = document.getElementById('sortBy').value;

    // Build query parameters for the API
    const params = new URLSearchParams({
        page: 1 // Reset to page 1 when applying filters
    });

    if (searchUser) params.append('search', searchUser);
    if (filterRank) params.append('rank', filterRank);
    if (sortBy) params.append('sort', sortBy);

    // Update current filters and load data
    currentFilters = Object.fromEntries(params.entries());
    delete currentFilters.page; // Remove page from stored filters

    loadVerifications(1);
}

function refreshData() {
    // Show loading state on button
    const refreshBtn = document.querySelector('[onclick="refreshData()"]');
    if (refreshBtn) {
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
        refreshBtn.disabled = true;

        // Reset the button after refresh
        setTimeout(() => {
            refreshBtn.innerHTML = originalHTML;
            refreshBtn.disabled = false;
        }, 1000);
    }

    // Reload both stats and verifications
    loadStats();
    loadVerifications(currentPage);
}

function viewPlayerDetails(playerId) {
    // Check if the modal element exists
    const modalElement = document.getElementById('playerModal');
    if (!modalElement) {
        // Create a simple modal if the main player modal doesn't exist
        showSimplePlayerInfo(playerId);
        return;
    }

    // Try to use the global function first
    if (typeof showPlayerDetails === 'function') {
        showPlayerDetails(playerId);
        return;
    }

    // Fallback: implement a local version
    showLocalPlayerDetails(playerId);
}

function showSimplePlayerInfo(playerId) {
    // Simple alert with player info for now
    fetch(`/api/player/${playerId}`)
        .then(response => response.json())
        .then(player => {
            if (player.error) {
                alert('Error loading player data: ' + player.error);
                return;
            }

            const info = `
Player: ${player.name}
MMR: ${player.mmr || 0}
Global MMR: ${player.global_mmr || 300}
Matches: ${player.matches || 0}
Win Rate: ${player.win_rate || 0}%
            `;
            alert(info);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load player details');
        });
}

function showLocalPlayerDetails(playerId) {
    // Implement the player modal locally for admin page
    const modalElement = document.getElementById('playerModal');
    let playerModal;

    if (typeof bootstrap !== 'undefined') {
        playerModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
    } else {
        alert('Bootstrap not available for modal');
        return;
    }

    const modalContent = document.getElementById('playerModalContent');
    if (!modalContent) {
        alert('Modal content element not found');
        return;
    }

    // Show loading
    modalContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading player data...</p>
        </div>
    `;

    playerModal.show();

    // Try to get player data, but handle 404 properly
    fetch(`/api/player/${playerId}`)
        .then(response => {
            if (response.status === 404) {
                // Player not found, show verification info instead
                showVerificationInfo(playerId);
                return null; // Don't try to parse JSON
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(player => {
            // Skip if we already showed verification info
            if (player === null) {
                return;
            }

            if (player.error) {
                modalContent.innerHTML = `<div class="alert alert-danger">${player.error}</div>`;
                return;
            }

            // Update modal title
            const modalTitle = document.getElementById('playerModalLabel');
            if (modalTitle) {
                modalTitle.textContent = player.name || 'Player Details';
            }

            // Display full player info
            modalContent.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4>${player.name}</h4>
                        <div class="card bg-dark mb-3">
                            <div class="card-body">
                                <h6>Ranked Stats</h6>
                                <p><strong>MMR:</strong> ${player.mmr || 0}</p>
                                <p><strong>Matches:</strong> ${player.matches || 0}</p>
                                <p><strong>Win Rate:</strong> ${player.win_rate || 0}%</p>
                                <p><strong>Record:</strong> ${player.wins || 0}-${player.losses || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark mb-3">
                            <div class="card-body">
                                <h6>Global Stats</h6>
                                <p><strong>Global MMR:</strong> ${player.global_mmr || 300}</p>
                                <p><strong>Global Matches:</strong> ${player.global_matches || 0}</p>
                                <p><strong>Global Win Rate:</strong> ${player.global_win_rate || 0}%</p>
                                <p><strong>Global Record:</strong> ${player.global_wins || 0}-${player.global_losses || 0}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching player details:', error);
            // On any error, show verification info
            showVerificationInfo(playerId);
        });

    function showVerificationInfo(playerId) {
        // Find the verification data from the current table data
        const currentVerifications = document.querySelectorAll('#verificationsTableBody tr');
        let verificationData = null;

        currentVerifications.forEach(row => {
            const actionButtons = row.querySelector('[onclick*="' + playerId + '"]');
            if (actionButtons) {
                const cells = row.querySelectorAll('td');
                verificationData = {
                    username: cells[0].textContent.trim(),
                    rank: cells[1].textContent.trim(),
                    date: cells[2].textContent.trim()
                };
            }
        });

        // Update modal title
        const modalTitle = document.getElementById('playerModalLabel');
        if (modalTitle) {
            modalTitle.textContent = verificationData ? verificationData.username : 'Player Details';
        }

        modalContent.innerHTML = `
            <div class="text-center">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This player has verified their rank but hasn't played any matches yet.
                </div>

                ${verificationData ? `
                <div class="card bg-dark">
                    <div class="card-body">
                        <h5><i class="fas fa-user me-2"></i>${verificationData.username}</h5>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Verified Rank:</strong></p>
                                <div>${verificationData.rank}</div>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Verification Date:</strong></p>
                                <p>${verificationData.date}</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <p class="text-muted mb-0">
                                <i class="fas fa-gamepad me-1"></i>
                                This player will appear in the players collection once they play their first match.
                            </p>
                        </div>
                    </div>
                </div>
                ` : `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Player information not available.
                </div>
                `}
            </div>
        `;
    }
}

function confirmDeleteVerification(discordId, username) {
    document.getElementById('confirmModalBody').innerHTML = `
        <p>Are you sure you want to delete the rank verification for <strong>${username}</strong>?</p>
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            This action cannot be undone. The user will need to verify their rank again.
        </div>
    `;

    document.getElementById('confirmActionBtn').onclick = function() {
        deleteVerification(discordId);
    };

    confirmModal.show();
}

function deleteVerification(discordId) {
    fetch(`/api/admin/rank-verification/${discordId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            confirmModal.hide();
            showSuccess('Rank verification deleted successfully');
            loadStats();
            loadVerifications(currentPage);
        } else {
            showError('Failed to delete verification: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error deleting verification:', error);
        showError('Failed to delete verification');
    });
}

function showSuccess(message) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function showError(message) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // Auto-remove after 8 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 8000);
}

// Utility function for debouncing search input
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}