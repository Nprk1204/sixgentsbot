{% extends "base.html" %}

{% block title %}My Stats - Rocket League Six Gents{% endblock %}

{% block chart_js %}
<!-- Chart.js for graphs - only loaded on this page -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="content-container">
    <div class="content-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div class="mb-3 mb-md-0">
                <h2><i class="fas fa-chart-line me-2"></i> Detailed Statistics</h2>
                <div class="user-indicator">
                    <i class="fas fa-user me-1"></i> {{ user.global_name or user.username }}
                    {% if rank_data %}
                        <span class="ms-2">
                            {% if rank_data.tier == 'Rank A' %}
                                <span class="badge bg-danger">{{ rank_data.tier }}</span>
                            {% elif rank_data.tier == 'Rank B' %}
                                <span class="badge bg-primary">{{ rank_data.tier }}</span>
                            {% elif rank_data.tier == 'Rank C' %}
                                <span class="badge bg-success">{{ rank_data.tier }}</span>
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="stats-actions">
                <button class="btn btn-outline-primary" onclick="refreshStats()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    {% set has_ranked_stats = player_data and player_data.matches and player_data.matches > 0 %}
    {% set has_global_stats = player_data and player_data.global_matches and player_data.global_matches > 0 %}
    {% set has_any_stats = has_ranked_stats or has_global_stats %}

    {% if not has_any_stats %}
        <!-- No Stats Available -->
        <div class="empty-state">
            <div class="card bg-dark-medium text-center">
                <div class="card-body py-5">
                    <div class="empty-state-icon mb-4">
                        <i class="fas fa-chart-line fa-5x text-muted"></i>
                    </div>
                    <h4>No Statistics Available</h4>
                    <p class="text-muted mb-4 lead">
                        You haven't played any matches yet! Join the queue in Discord to start building your stats.
                    </p>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="getting-started-enhanced p-4 rounded">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-rocket me-2"></i> Getting Started
                                </h6>
                                <div class="row">
                                    <div class="col-md-4 text-center mb-3">
                                        <div class="step-circle">1</div>
                                        <h6 class="mt-2">Verify Rank</h6>
                                        <small class="text-muted">Get your Discord role</small>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <div class="step-circle">2</div>
                                        <h6 class="mt-2">Join Queue</h6>
                                        <small class="text-muted">Use <code>/queue</code></small>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <div class="step-circle">3</div>
                                        <h6 class="mt-2">Track Progress</h6>
                                        <small class="text-muted">Watch stats grow</small>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    {% if not rank_data %}
                                        <a href="{{ url_for('profile_rank_check') }}" class="btn btn-primary">
                                            <i class="fas fa-check-circle me-1"></i> Verify Your Rank First
                                        </a>
                                    {% else %}
                                        <p class="text-success mb-0">
                                            <i class="fas fa-check me-1"></i> Rank verified! Ready to play.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Enhanced Stats Layout -->
        <ul class="nav nav-tabs enhanced-tabs mb-4" id="statsTabsNav" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                        data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-1"></i> Overview
                </button>
            </li>
            {% if has_ranked_stats %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranked-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#ranked-stats" type="button" role="tab">
                    <i class="fas fa-trophy me-1"></i> Ranked Stats
                </button>
            </li>
            {% endif %}
            {% if has_global_stats %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="global-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#global-stats" type="button" role="tab">
                    <i class="fas fa-globe me-1"></i> Global Stats
                </button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab"
                        data-bs-target="#advanced" type="button" role="tab">
                    <i class="fas fa-microscope me-1"></i> Advanced
                </button>
            </li>
        </ul>

        <div class="tab-content enhanced-tab-content" id="statsTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Performance Overview Cards -->
                <div class="row mb-4">
                    {% if has_ranked_stats %}
                    <div class="col-lg-6 mb-4">
                        <div class="card bg-dark-medium h-100 border-warning border-start border-3">
                            <div class="card-header bg-dark">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 text-warning">
                                            <i class="fas fa-trophy me-2"></i> Ranked Performance
                                        </h5>
                                        <small class="text-muted">Competitive tier matches</small>
                                    </div>
                                    {% if rank_data and rank_data.tier %}
                                        {% if rank_data.tier == 'Rank A' %}
                                            <span class="badge bg-danger fs-6">{{ rank_data.tier }}</span>
                                        {% elif rank_data.tier == 'Rank B' %}
                                            <span class="badge bg-primary fs-6">{{ rank_data.tier }}</span>
                                        {% else %}
                                            <span class="badge bg-success fs-6">{{ rank_data.tier }}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- MMR Display -->
                                <div class="text-center mb-4">
                                    <div class="display-4 text-warning fw-bold mb-2">{{ player_data.mmr or 0 }}</div>
                                    <div class="text-muted">Current MMR</div>
                                </div>

                                <!-- Stats Grid -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-info mb-1">{{ player_data.matches or 0 }}</div>
                                            <small class="text-muted">Matches</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-success mb-1">{{ player_data.wins or 0 }}</div>
                                            <small class="text-muted">Wins</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-danger mb-1">{{ player_data.losses or 0 }}</div>
                                            <small class="text-muted">Losses</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Win Rate Progress -->
                                {% set win_rate = (player_data.wins / player_data.matches * 100) if player_data.matches > 0 else 0 %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="small">Win Rate</span>
                                        <span class="small fw-bold">{{ "%.1f"|format(win_rate) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ win_rate }}%" aria-valuenow="{{ win_rate }}"
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>

                                <!-- Current Streak -->
                                {% if player_data.current_streak %}
                                    <div class="text-center">
                                        {% if player_data.current_streak > 0 %}
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-fire me-1"></i> {{ player_data.current_streak }} Win Streak
                                            </span>
                                        {% elif player_data.current_streak < 0 %}
                                            <span class="badge bg-danger fs-6">
                                                <i class="fas fa-arrow-down me-1"></i> {{ abs(player_data.current_streak) }} Loss Streak
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if has_global_stats %}
                    <div class="col-lg-6 mb-4">
                        <div class="card bg-dark-medium h-100 border-primary border-start border-3">
                            <div class="card-header bg-dark">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 text-primary">
                                            <i class="fas fa-globe me-2"></i> Global Performance
                                        </h5>
                                        <small class="text-muted">Cross-rank matches</small>
                                    </div>
                                    <span class="badge bg-primary fs-6">Global</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Global MMR Display -->
                                <div class="text-center mb-4">
                                    <div class="display-4 text-primary fw-bold mb-2">{{ player_data.global_mmr or 300 }}</div>
                                    <div class="text-muted">Global MMR</div>
                                </div>

                                <!-- Global Stats Grid -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-info mb-1">{{ player_data.global_matches or 0 }}</div>
                                            <small class="text-muted">Matches</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-success mb-1">{{ player_data.global_wins or 0 }}</div>
                                            <small class="text-muted">Wins</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-danger mb-1">{{ player_data.global_losses or 0 }}</div>
                                            <small class="text-muted">Losses</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Global Win Rate Progress -->
                                {% set global_win_rate = (player_data.global_wins / player_data.global_matches * 100) if player_data.global_matches > 0 else 0 %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="small">Win Rate</span>
                                        <span class="small fw-bold">{{ "%.1f"|format(global_win_rate) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-primary" role="progressbar"
                                             style="width: {{ global_win_rate }}%" aria-valuenow="{{ global_win_rate }}"
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>

                                <!-- Global Current Streak -->
                                {% if player_data.global_current_streak %}
                                    <div class="text-center">
                                        {% if player_data.global_current_streak > 0 %}
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-fire me-1"></i> {{ player_data.global_current_streak }} Win Streak
                                            </span>
                                        {% elif player_data.global_current_streak < 0 %}
                                            <span class="badge bg-danger fs-6">
                                                <i class="fas fa-arrow-down me-1"></i> {{ abs(player_data.global_current_streak) }} Loss Streak
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Charts Section -->
                {% if (ranked_matches and ranked_matches|length > 0) or (global_matches and global_matches|length > 0) %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i> MMR Progress Over Time
                                </h5>
                                <small class="text-muted">Track your improvement across all matches</small>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="mmrChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Career Summary -->
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Recent Activity -->
                        {% if recent_matches and recent_matches|length > 0 %}
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-clock me-2"></i> Recent Activity
                                </h5>
                                <small class="text-muted">Your last {{ recent_matches|length }} matches</small>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Result</th>
                                                <th>MMR Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for match in recent_matches[:5] %}
                                            <tr>
                                                <td>{{ match.date }}</td>
                                                <td>
                                                    {% if match.is_global %}
                                                        <span class="badge bg-primary">Global</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Ranked</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.player_result == 'Win' %}
                                                        <span class="badge bg-success">Win</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Loss</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.mmr_change %}
                                                        {% if match.mmr_change > 0 %}
                                                            <span class="text-success">+{{ match.mmr_change }}</span>
                                                        {% else %}
                                                            <span class="text-danger">{{ match.mmr_change }}</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="switchToAdvancedTab()">
                                        <i class="fas fa-list me-1"></i> View All Matches
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-lg-4">
                        <!-- Career Summary -->
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-award me-2"></i> Career Summary
                                </h5>
                            </div>
                            <div class="card-body">
                                {% set total_matches = (player_data.matches or 0) + (player_data.global_matches or 0) %}
                                {% set total_wins = (player_data.wins or 0) + (player_data.global_wins or 0) %}

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Matches</span>
                                        <strong>{{ total_matches }}</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Wins</span>
                                        <strong class="text-success">{{ total_wins }}</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Overall Win Rate</span>
                                        <strong>{{ "%.1f"|format((total_wins / total_matches * 100) if total_matches > 0 else 0) }}%</strong>
                                    </div>
                                </div>

                                {% if has_ranked_stats %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Peak Ranked MMR</span>
                                        <strong class="text-warning">{{ player_data.mmr or 0 }}</strong>
                                    </div>
                                </div>
                                {% endif %}

                                {% if has_global_stats %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Peak Global MMR</span>
                                        <strong class="text-primary">{{ player_data.global_mmr or 300 }}</strong>
                                    </div>
                                </div>
                                {% endif %}

                                {% if player_data.longest_win_streak or player_data.global_longest_win_streak %}
                                <div class="text-center mt-4">
                                    {% set ranked_best_streak = player_data.longest_win_streak or 0 %}
                                    {% set global_best_streak = player_data.global_longest_win_streak or 0 %}
                                    {% set best_overall_streak = ranked_best_streak if ranked_best_streak > global_best_streak else global_best_streak %}
                                    <div class="badge bg-warning text-dark fs-6">
                                        <i class="fas fa-fire me-1"></i> Best Streak: {{ best_overall_streak }}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranked Stats Tab -->
            {% if has_ranked_stats %}
            <div class="tab-pane fade" id="ranked-stats" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card primary">
                            <div class="stat-card-icon"><i class="fas fa-trophy"></i></div>
                            <div class="stat-card-value">{{ player_data.mmr or 0 }}</div>
                            <div class="stat-card-title">Current MMR</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card secondary">
                            <div class="stat-card-icon"><i class="fas fa-gamepad"></i></div>
                            <div class="stat-card-value">{{ player_data.matches or 0 }}</div>
                            <div class="stat-card-title">Total Matches</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card accent">
                            <div class="stat-card-icon"><i class="fas fa-percentage"></i></div>
                            <div class="stat-card-value">{{ "%.1f"|format((player_data.wins or 0) / (player_data.matches or 1) * 100) }}%</div>
                            <div class="stat-card-title">Win Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="fas fa-fire"></i></div>
                            <div class="stat-card-value">{{ player_data.current_streak or 0 }}</div>
                            <div class="stat-card-title">Current Streak</div>
                        </div>
                    </div>
                </div>

                {% if ranked_matches and ranked_matches|length > 0 %}
                <div class="card bg-dark-medium">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i> Ranked MMR History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 300px;">
                            <canvas id="rankedChart"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Global Stats Tab -->
            {% if has_global_stats %}
            <div class="tab-pane fade" id="global-stats" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card primary">
                            <div class="stat-card-icon"><i class="fas fa-globe"></i></div>
                            <div class="stat-card-value">{{ player_data.global_mmr or 300 }}</div>
                            <div class="stat-card-title">Global MMR</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card secondary">
                            <div class="stat-card-icon"><i class="fas fa-gamepad"></i></div>
                            <div class="stat-card-value">{{ player_data.global_matches or 0 }}</div>
                            <div class="stat-card-title">Global Matches</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card accent">
                            <div class="stat-card-icon"><i class="fas fa-percentage"></i></div>
                            <div class="stat-card-value">{{ "%.1f"|format((player_data.global_wins or 0) / (player_data.global_matches or 1) * 100) }}%</div>
                            <div class="stat-card-title">Win Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="fas fa-fire"></i></div>
                            <div class="stat-card-value">{{ player_data.global_current_streak or 0 }}</div>
                            <div class="stat-card-title">Current Streak</div>
                        </div>
                    </div>
                </div>

                {% if global_matches and global_matches|length > 0 %}
                <div class="card bg-dark-medium">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i> Global MMR History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 300px;">
                            <canvas id="globalChart"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Advanced Tab -->
            <div class="tab-pane fade" id="advanced" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Match History -->
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div>
                                        <h5 class="mb-0">
                                            <i class="fas fa-history me-2"></i> Complete Match History
                                        </h5>
                                        <small class="text-muted">All your matches with detailed information</small>
                                    </div>
                                    <div class="match-filters mt-2 mt-md-0">
                                        <button class="btn btn-sm btn-outline-primary active" onclick="filterMatches('all')">All</button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="filterMatches('ranked')">Ranked</button>
                                        <button class="btn btn-sm btn-outline-info" onclick="filterMatches('global')">Global</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if recent_matches and recent_matches|length > 0 %}
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-calendar me-1"></i> Date</th>
                                                <th><i class="fas fa-tag me-1"></i> Type</th>
                                                <th><i class="fas fa-trophy me-1"></i> Result</th>
                                                <th><i class="fas fa-chart-line me-1"></i> MMR Change</th>
                                                <th><i class="fas fa-fire me-1"></i> Streak</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for match in recent_matches %}
                                            <tr class="match-row" data-type="{{ 'global' if match.is_global else 'ranked' }}">
                                                <td>{{ match.date }}</td>
                                                <td>
                                                    {% if match.is_global %}
                                                        <span class="badge bg-primary">
                                                            <i class="fas fa-globe me-1"></i> Global
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-trophy me-1"></i> Ranked
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.player_result == 'Win' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-trophy me-1"></i> Win
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-times me-1"></i> Loss
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.mmr_change %}
                                                        {% if match.mmr_change > 0 %}
                                                            <span class="text-success fw-bold">
                                                                <i class="fas fa-arrow-up me-1"></i> +{{ match.mmr_change }}
                                                            </span>
                                                        {% else %}
                                                            <span class="text-danger fw-bold">
                                                                <i class="fas fa-arrow-down me-1"></i> {{ match.mmr_change }}
                                                            </span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.streak_display %}
                                                        <span class="streak-indicator">{{ match.streak_display }}</span>
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-history fa-4x text-muted mb-3"></i>
                                    <h6>No Match History</h6>
                                    <p class="text-muted">Start playing to see your matches here!</p>
                                    <a href="{{ url_for('home') }}" class="btn btn-primary">
                                        <i class="fas fa-gamepad me-1"></i> Learn How to Play
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Advanced Analytics -->
                        <div class="card bg-dark-medium mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-microscope me-2"></i> Advanced Analytics
                                </h5>
                                <small class="text-muted">Detailed performance insights</small>
                            </div>
                            <div class="card-body">
                                <!-- Performance Comparison -->
                                {% if has_ranked_stats and has_global_stats %}
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-balance-scale me-1"></i> Performance Comparison
                                    </h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                                            <span class="small">
                                                <i class="fas fa-trophy me-1 text-warning"></i> Ranked Win Rate
                                            </span>
                                            <span class="fw-bold">{{ "%.1f"|format((player_data.wins / player_data.matches * 100) if player_data.matches > 0 else 0) }}%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                                            <span class="small">
                                                <i class="fas fa-globe me-1 text-primary"></i> Global Win Rate
                                            </span>
                                            <span class="fw-bold text-primary">{{ "%.1f"|format((player_data.global_wins / player_data.global_matches * 100) if player_data.global_matches > 0 else 0) }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Recent Form -->
                                {% if recent_matches and recent_matches|length >= 5 %}
                                <div class="mb-4">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-chart-bar me-1"></i> Recent Form (Last 5)
                                    </h6>
                                    <div class="d-flex justify-content-center mb-3">
                                        {% for match in recent_matches[:5] %}
                                            {% if match.player_result == 'Win' %}
                                                <span class="badge bg-success me-1" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" title="Win - {{ match.date }}">W</span>
                                            {% else %}
                                                <span class="badge bg-danger me-1" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" title="Loss - {{ match.date }}">L</span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="text-center">
                                        {% set recent_wins = recent_matches[:5] | selectattr("player_result", "equalto", "Win") | list | length %}
                                        <small class="text-muted">{{ recent_wins }}/5 wins in recent matches</small>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Activity Stats -->
                                <div class="mb-4">
                                    <h6 class="text-info mb-3">
                                        <i class="fas fa-clock me-1"></i> Activity
                                    </h6>
                                    {% set total_matches = (player_data.matches or 0) + (player_data.global_matches or 0) %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                                            <span class="small">Total Games</span>
                                            <span class="fw-bold">{{ total_matches }}</span>
                                        </div>
                                    </div>
                                    {% if total_matches > 0 and recent_matches %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                                            <span class="small">Last Match</span>
                                            <span class="fw-bold">{{ recent_matches[0].date }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if has_ranked_stats and has_global_stats %}
                                        {% set ranked_percentage = ((player_data.matches or 0) / total_matches * 100) if total_matches > 0 else 0 %}
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                                                <span class="small">Ranked Games</span>
                                                <span class="fw-bold">{{ "%.0f"|format(ranked_percentage) }}%</span>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-bolt me-2"></i> Quick Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('leaderboard') }}" class="btn btn-primary">
                                        <i class="fas fa-trophy me-2"></i> View Leaderboard
                                    </a>
                                    <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                                        <i class="fas fa-user me-2"></i> Back to Profile
                                    </a>
                                    {% if not rank_data %}
                                        <a href="{{ url_for('profile_rank_check') }}" class="btn btn-warning">
                                            <i class="fas fa-check-circle me-2"></i> Verify Rank
                                        </a>
                                    {% endif %}
                                    <button class="btn btn-outline-primary" onclick="refreshStats()">
                                        <i class="fas fa-sync-alt me-2"></i> Refresh Stats
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Chart data and functionality
const chartData = {
    ranked: {{ ranked_matches | tojsonfilter | safe if ranked_matches else [] }},
    global: {{ global_matches | tojsonfilter | safe if global_matches else [] }}
};

// Chart.js configuration
Chart.defaults.color = '#f1f1f1';
Chart.defaults.borderColor = '#2a303c';

// Helper functions
function refreshStats() {
    const refreshBtns = document.querySelectorAll('[onclick="refreshStats()"]');

    refreshBtns.forEach(btn => {
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
            btn.disabled = true;
        }
    });

    setTimeout(() => {
        window.location.reload();
    }, 500);
}

function switchToAdvancedTab() {
    const advancedTab = document.getElementById('advanced-tab');
    const advancedTabPane = document.getElementById('advanced');

    if (advancedTab && advancedTabPane) {
        document.querySelectorAll('#statsTabsNav .nav-link').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        advancedTab.classList.add('active');
        advancedTabPane.classList.add('show', 'active');
    }
}

function filterMatches(type) {
    const rows = document.querySelectorAll('.match-row');
    const buttons = document.querySelectorAll('.match-filters .btn');

    buttons.forEach(btn => btn.classList.remove('active'));

    const clickedButton = Array.from(buttons).find(btn =>
        btn.textContent.toLowerCase().includes(type) ||
        (type === 'all' && btn.textContent.toLowerCase().includes('all'))
    );
    if (clickedButton) {
        clickedButton.classList.add('active');
    }

    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
            row.style.opacity = '1';
        } else {
            row.style.opacity = '0';
            setTimeout(() => {
                if (!row.dataset.type.includes(type) && type !== 'all') {
                    row.style.display = 'none';
                }
            }, 150);
        }
    });
}

// Chart creation
document.addEventListener('DOMContentLoaded', function() {
    // Create charts if data exists
    const mmrCtx = document.getElementById('mmrChart');
    if (mmrCtx && (chartData.ranked.length > 0 || chartData.global.length > 0)) {
        createChart(mmrCtx, 'combined');
    }

    const rankedCtx = document.getElementById('rankedChart');
    if (rankedCtx && chartData.ranked.length > 0) {
        createChart(rankedCtx, 'ranked');
    }

    const globalCtx = document.getElementById('globalChart');
    if (globalCtx && chartData.global.length > 0) {
        createChart(globalCtx, 'global');
    }

    // Initialize tooltips
    const tooltipElements = document.querySelectorAll('[title]');
    tooltipElements.forEach(element => {
        new bootstrap.Tooltip(element);
    });
});

function createChart(ctx, type) {
    const datasets = [];

    if (type === 'combined' || type === 'ranked') {
        if (chartData.ranked.length > 0) {
            datasets.push({
                label: 'Ranked MMR',
                data: chartData.ranked.map((match, index) => ({
                    x: index + 1,
                    y: match.new_mmr || 0
                })),
                borderColor: '#ffd700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                tension: 0.4,
                fill: false,
                borderWidth: 3,
                pointBackgroundColor: '#ffd700',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            });
        }
    }

    if (type === 'combined' || type === 'global') {
        if (chartData.global.length > 0) {
            datasets.push({
                label: 'Global MMR',
                data: chartData.global.map((match, index) => ({
                    x: index + 1,
                    y: match.new_mmr || 0
                })),
                borderColor: '#00a8ff',
                backgroundColor: 'rgba(0, 168, 255, 0.1)',
                tension: 0.4,
                fill: false,
                borderWidth: 3,
                pointBackgroundColor: '#00a8ff',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            });
        }
    }

    if (datasets.length === 0) {
        ctx.getContext('2d').fillText('No data available', 10, 50);
        return;
    }

    new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: datasets.length > 1,
                    position: 'top',
                    labels: {
                        color: '#f1f1f1',
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#f1f1f1',
                    bodyColor: '#f1f1f1',
                    borderColor: '#2a303c',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function(tooltipItems) {
                            return `Match ${tooltipItems[0].parsed.x}`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} MMR`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Match Number',
                        color: '#f1f1f1',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    ticks: {
                        color: '#a0a8b1',
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(42, 48, 60, 0.5)',
                        drawBorder: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'MMR',
                        color: '#f1f1f1',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    ticks: {
                        color: '#a0a8b1',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(42, 48, 60, 0.5)',
                        drawBorder: false
                    },
                    beginAtZero: false
                }
            }
        }
    });
}

console.log('Profile Stats loaded');
console.log('Chart data:', chartData);
console.log('Has ranked stats:', chartData.ranked.length > 0);
console.log('Has global stats:', chartData.global.length > 0);
</script>
{% endblock %}