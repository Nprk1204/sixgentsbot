{% extends "base.html" %}

{% block title %}My Stats - Rocket League Six Gents{% endblock %}

{% block content %}
<div class="content-container">
    <div class="content-header">
        <h2><i class="fas fa-chart-line me-2"></i> Detailed Statistics</h2>
        <div class="user-indicator">
            <i class="fas fa-user me-1"></i> {{ user.global_name or user.username }}
        </div>
    </div>

    {% set has_ranked_stats = player_data and player_data.matches and player_data.matches > 0 %}
    {% set has_global_stats = player_data and player_data.global_matches and player_data.global_matches > 0 %}
    {% set has_any_stats = has_ranked_stats or has_global_stats %}

    {% if not has_any_stats %}
        <!-- No Stats Available -->
        <div class="card bg-dark-medium">
            <div class="card-body text-center py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                <h4>No Statistics Available</h4>
                <p class="text-muted mb-4">
                    You haven't played any matches yet! Join the queue in Discord to start building your stats.
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="getting-started-card p-4 rounded" style="background: rgba(0, 168, 255, 0.1); border: 1px solid var(--border);">
                            <h6 class="text-primary mb-3">Getting Started</h6>
                            <ol class="text-start">
                                <li class="mb-2">Join our Discord server</li>
                                <li class="mb-2">Use <code>/join</code> to join the queue</li>
                                <li class="mb-2">Play matches and report results</li>
                                <li>Watch your stats grow here!</li>
                            </ol>
                            <a href="{{ url_for('profile_rank_check') }}" class="btn btn-primary btn-sm mt-2">
                                <i class="fas fa-check-circle me-1"></i> Verify Your Rank First
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Stats Available -->
        <ul class="nav nav-tabs mb-4" id="statsTabsNav" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                        data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-1"></i> Overview
                </button>
            </li>
            {% if has_ranked_stats %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranked-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#ranked-stats" type="button" role="tab">
                    <i class="fas fa-trophy me-1"></i> Ranked Stats
                </button>
            </li>
            {% endif %}
            {% if has_global_stats %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="global-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#global-stats" type="button" role="tab">
                    <i class="fas fa-globe me-1"></i> Global Stats
                </button>
            </li>
            {% endif %}
        </ul>

        <div class="tab-content" id="statsTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row">
                    {% if has_ranked_stats %}
                    <div class="col-lg-6">
                        <div class="card bg-dark-medium mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Ranked Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="stat-item text-center p-3">
                                            <h3 class="text-primary">{{ player_data.mmr or 0 }}</h3>
                                            <small class="text-muted">Current MMR</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item text-center p-3">
                                            <h3 class="text-success">{{ "%.1f"|format((player_data.wins or 0) / (player_data.matches or 1) * 100) }}%</h3>
                                            <small class="text-muted">Win Rate</small>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <span class="badge bg-info me-2">{{ player_data.matches or 0 }} Matches</span>
                                    <span class="badge bg-success me-2">{{ player_data.wins or 0 }} Wins</span>
                                    <span class="badge bg-danger">{{ player_data.losses or 0 }} Losses</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if has_global_stats %}
                    <div class="col-lg-6">
                        <div class="card bg-dark-medium mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Global Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="stat-item text-center p-3">
                                            <h3 class="text-primary">{{ player_data.global_mmr or 300 }}</h3>
                                            <small class="text-muted">Global MMR</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item text-center p-3">
                                            <h3 class="text-success">{{ "%.1f"|format((player_data.global_wins or 0) / (player_data.global_matches or 1) * 100) }}%</h3>
                                            <small class="text-muted">Win Rate</small>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <span class="badge bg-info me-2">{{ player_data.global_matches or 0 }} Matches</span>
                                    <span class="badge bg-success me-2">{{ player_data.global_wins or 0 }} Wins</span>
                                    <span class="badge bg-danger">{{ player_data.global_losses or 0 }} Losses</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if not has_ranked_stats and not has_global_stats %}
                    <div class="col-12">
                        <div class="card bg-dark-medium mb-4">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                                <h5>No Match Data</h5>
                                <p class="text-muted">Start playing matches to see your performance statistics here!</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Performance Charts -->
                {% if (ranked_matches and ranked_matches|length > 0) or (global_matches and global_matches|length > 0) %}
                <div class="card bg-dark-medium">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> MMR Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="mmrChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Ranked Stats Tab -->
            {% if has_ranked_stats %}
            <div class="tab-pane fade" id="ranked-stats" role="tabpanel">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="stat-card-value">{{ player_data.mmr or 0 }}</div>
                            <div class="stat-card-title">Current MMR</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card secondary">
                            <div class="stat-card-value">{{ player_data.matches or 0 }}</div>
                            <div class="stat-card-title">Total Matches</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card accent">
                            <div class="stat-card-value">{{ "%.1f"|format((player_data.wins or 0) / (player_data.matches or 1) * 100) }}%</div>
                            <div class="stat-card-title">Win Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-card-value">{{ player_data.current_streak or 0 }}</div>
                            <div class="stat-card-title">Current Streak</div>
                        </div>
                    </div>
                </div>

                <!-- Ranked chart -->
                {% if ranked_matches and ranked_matches|length > 0 %}
                <div class="card bg-dark-medium mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Ranked MMR History</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rankedChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Global Stats Tab -->
            {% if has_global_stats %}
            <div class="tab-pane fade" id="global-stats" role="tabpanel">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="stat-card-value">{{ player_data.global_mmr or 300 }}</div>
                            <div class="stat-card-title">Global MMR</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card secondary">
                            <div class="stat-card-value">{{ player_data.global_matches or 0 }}</div>
                            <div class="stat-card-title">Global Matches</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card accent">
                            <div class="stat-card-value">{{ "%.1f"|format((player_data.global_wins or 0) / (player_data.global_matches or 1) * 100) }}%</div>
                            <div class="stat-card-title">Win Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-card-value">{{ player_data.global_current_streak or 0 }}</div>
                            <div class="stat-card-title">Current Streak</div>
                        </div>
                    </div>
                </div>

                <!-- Global chart -->
                {% if global_matches and global_matches|length > 0 %}
                <div class="card bg-dark-medium mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Global MMR History</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="globalChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Chart configuration and data
const chartData = {
    ranked: {{ ranked_matches | tojsonfilter | safe if ranked_matches else [] }},
    global: {{ global_matches | tojsonfilter | safe if global_matches else [] }}
};

// Chart.js default configuration
Chart.defaults.color = '#f1f1f1';
Chart.defaults.borderColor = '#2a303c';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Chart data:', chartData);

    // Combined MMR chart
    const mmrCtx = document.getElementById('mmrChart');
    if (mmrCtx && (chartData.ranked.length > 0 || chartData.global.length > 0)) {
        const datasets = [];

        if (chartData.ranked.length > 0) {
            datasets.push({
                label: 'Ranked MMR',
                data: chartData.ranked.map(match => ({
                    x: match.date,
                    y: match.new_mmr
                })),
                borderColor: '#00a8ff',
                backgroundColor: 'rgba(0, 168, 255, 0.1)',
                tension: 0.3
            });
        }

        if (chartData.global.length > 0) {
            datasets.push({
                label: 'Global MMR',
                data: chartData.global.map(match => ({
                    x: match.date,
                    y: match.new_mmr
                })),
                borderColor: '#ff7e31',
                backgroundColor: 'rgba(255, 126, 49, 0.1)',
                tension: 0.3
            });
        }

        new Chart(mmrCtx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            parser: 'YYYY-MM-DDTHH:mm:ss.SSSZ',
                            displayFormats: {
                                day: 'MMM DD',
                                week: 'MMM DD',
                                month: 'MMM YYYY'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'MMR'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return new Date(tooltipItems[0].parsed.x).toLocaleDateString();
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // Individual ranked chart
    const rankedCtx = document.getElementById('rankedChart');
    if (rankedCtx && chartData.ranked.length > 0) {
        new Chart(rankedCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Ranked MMR',
                    data: chartData.ranked.map(match => ({
                        x: match.date,
                        y: match.new_mmr
                    })),
                    borderColor: '#00a8ff',
                    backgroundColor: 'rgba(0, 168, 255, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            parser: 'YYYY-MM-DDTHH:mm:ss.SSSZ',
                            displayFormats: {
                                day: 'MMM DD',
                                week: 'MMM DD',
                                month: 'MMM YYYY'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'MMR'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Individual global chart
    const globalCtx = document.getElementById('globalChart');
    if (globalCtx && chartData.global.length > 0) {
        new Chart(globalCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Global MMR',
                    data: chartData.global.map(match => ({
                        x: match.date,
                        y: match.new_mmr
                    })),
                    borderColor: '#ff7e31',
                    backgroundColor: 'rgba(255, 126, 49, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            parser: 'YYYY-MM-DDTHH:mm:ss.SSSZ',
                            displayFormats: {
                                day: 'MMM DD',
                                week: 'MMM DD',
                                month: 'MMM YYYY'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'MMR'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}