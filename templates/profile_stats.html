{% extends "base.html" %}

{% block title %}My Stats - Rocket League Six Gents{% endblock %}

{% block chart_js %}
<!-- Chart.js for graphs - only loaded on this page -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="content-container">
    <!-- Add these debug sections to your profile_stats.html template -->
<!-- Place right after <div class="content-container"> and before <div class="content-header"> -->

<!-- FIRST DEBUG SECTION - Template Data -->
<div class="alert alert-info mb-4">
    <h5>üîç Profile Stats Debug (Remove when fixed)</h5>
    <div class="row">
        <div class="col-md-6">
            <p><strong>Player Data:</strong> {{ "‚úÖ Exists" if player_data else "‚ùå Missing" }}</p>
            <p><strong>Recent Matches:</strong> {{ "‚úÖ " + (recent_matches|length|string) + " found" if recent_matches else "‚ùå None" }}</p>
            <p><strong>Ranked Matches:</strong> {{ "‚úÖ " + (ranked_matches|length|string) + " found" if ranked_matches else "‚ùå None" }}</p>
            <p><strong>Global Matches:</strong> {{ "‚úÖ " + (global_matches|length|string) + " found" if global_matches else "‚ùå None" }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Template Variables:</strong></p>
            <p>- has_ranked_stats: {{ has_ranked_stats if has_ranked_stats is defined else "undefined" }}</p>
            <p>- has_global_stats: {{ has_global_stats if has_global_stats is defined else "undefined" }}</p>
            <p>- has_any_stats: {{ has_any_stats if has_any_stats is defined else "undefined" }}</p>
            <p>- Player matches: {{ player_data.matches if player_data else "N/A" }}</p>
            <p>- Player global_matches: {{ player_data.global_matches if player_data else "N/A" }}</p>
        </div>
    </div>

    {% if recent_matches %}
    <details>
        <summary>üìã Recent Matches ({{ recent_matches|length }})</summary>
        <pre style="font-size: 10px; background: #000; color: #0f0; padding: 10px; max-height: 150px; overflow-y: auto;">{{ recent_matches|pprint }}</pre>
    </details>
    {% endif %}
</div>

<!-- SECOND DEBUG SECTION - JavaScript Data -->
<div class="alert alert-danger mb-4">
    <h5>üîç JavaScript Data Debug</h5>
    <div class="row">
        <div class="col-md-6">
            <p><strong>matchesData length:</strong> <span id="jsMatchesLength">Loading...</span></p>
            <p><strong>chartData.ranked length:</strong> <span id="jsRankedLength">Loading...</span></p>
            <p><strong>chartData.global length:</strong> <span id="jsGlobalLength">Loading...</span></p>
            <p><strong>Variables defined:</strong> <span id="jsVariableCheck">Loading...</span></p>
        </div>
        <div class="col-md-6">
            <p><strong>Raw matchesData:</strong></p>
            <pre id="jsMatchesRaw" style="font-size: 10px; max-height: 100px; overflow-y: auto; background: #000; color: #0f0; padding: 5px;">Loading...</pre>
        </div>
    </div>
    <div class="mt-3">
        <p><strong>Template JSON Output:</strong></p>
        <details>
            <summary>Click to see raw template data</summary>
            <pre style="font-size: 10px; background: #000; color: #ff0; padding: 10px; max-height: 150px; overflow-y: auto;">
recent_matches: {{ recent_matches | tojsonfilter | safe if recent_matches else "null" }}

ranked_matches: {{ ranked_matches | tojsonfilter | safe if ranked_matches else "null" }}

global_matches: {{ global_matches | tojsonfilter | safe if global_matches else "null" }}
            </pre>
        </details>
    </div>
</div>

<script>
// Enhanced debug logging
console.log('=== JAVASCRIPT DEBUG START ===');

// Check if variables are defined
console.log('Variables check:');
console.log('- typeof matchesData:', typeof matchesData);
console.log('- typeof chartData:', typeof chartData);

// Try to access the data
try {
    console.log('matchesData:', matchesData);
} catch (e) {
    console.error('Error accessing matchesData:', e);
}

try {
    console.log('chartData:', chartData);
} catch (e) {
    console.error('Error accessing chartData:', e);
}

// Update debug display when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, updating debug display...');

    try {
        document.getElementById('jsMatchesLength').textContent =
            (typeof matchesData !== 'undefined' && matchesData) ? matchesData.length : 'undefined';

        document.getElementById('jsRankedLength').textContent =
            (typeof chartData !== 'undefined' && chartData && chartData.ranked) ? chartData.ranked.length : 'undefined';

        document.getElementById('jsGlobalLength').textContent =
            (typeof chartData !== 'undefined' && chartData && chartData.global) ? chartData.global.length : 'undefined';

        document.getElementById('jsVariableCheck').textContent =
            `matchesData: ${typeof matchesData}, chartData: ${typeof chartData}`;

        document.getElementById('jsMatchesRaw').textContent =
            (typeof matchesData !== 'undefined') ? JSON.stringify(matchesData, null, 2) : 'matchesData is undefined';
    } catch (error) {
        console.error('Error updating debug display:', error);
        document.getElementById('jsMatchesRaw').textContent = 'Error: ' + error.message;
    }
});

console.log('=== JAVASCRIPT DEBUG END ===');
</script>

    <!-- Enhanced Header -->
    <div class="content-header">
        <div class="d-flex justify-content-between align-items-start w-100">
            <div class="header-left">
                <h2><i class="fas fa-chart-line me-2"></i> Detailed Statistics</h2>
                <div class="user-indicator">
                    <i class="fas fa-user me-2"></i>
                    <span class="user-name">{{ user.global_name or user.username }}</span>
                    {% if rank_data %}
                        {% if rank_data.tier == 'Rank A' %}
                            <span class="badge bg-danger ms-2">{{ rank_data.tier }}</span>
                        {% elif rank_data.tier == 'Rank B' %}
                            <span class="badge bg-primary ms-2">{{ rank_data.tier }}</span>
                        {% elif rank_data.tier == 'Rank C' %}
                            <span class="badge bg-success ms-2">{{ rank_data.tier }}</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-outline-primary" onclick="refreshStats()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    {% set has_ranked_stats = player_data and player_data.matches and player_data.matches > 0 %}
    {% set has_global_stats = player_data and player_data.global_matches and player_data.global_matches > 0 %}
    {% set has_any_stats = has_ranked_stats or has_global_stats %}

    {% if not has_any_stats %}
        <!-- No Stats Available -->
        <div class="empty-state">
            <div class="card bg-dark-medium text-center">
                <div class="card-body py-5">
                    <div class="empty-state-icon mb-4">
                        <i class="fas fa-chart-line fa-5x text-muted"></i>
                    </div>
                    <h4>No Statistics Available</h4>
                    <p class="text-muted mb-4 lead">
                        You haven't played any matches yet! Join the queue in Discord to start building your stats.
                    </p>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="getting-started-enhanced p-4 rounded">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-rocket me-2"></i> Getting Started
                                </h6>
                                <div class="row">
                                    <div class="col-md-4 text-center mb-3">
                                        <div class="step-circle">1</div>
                                        <h6 class="mt-2">Verify Rank</h6>
                                        <small class="text-muted">Get your Discord role</small>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <div class="step-circle">2</div>
                                        <h6 class="mt-2">Join Queue</h6>
                                        <small class="text-muted">Use <code>/queue</code></small>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <div class="step-circle">3</div>
                                        <h6 class="mt-2">Track Progress</h6>
                                        <small class="text-muted">Watch stats grow</small>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    {% if not rank_data %}
                                        <a href="{{ url_for('profile_rank_check') }}" class="btn btn-primary">
                                            <i class="fas fa-check-circle me-1"></i> Verify Your Rank First
                                        </a>
                                    {% else %}
                                        <p class="text-success mb-0">
                                            <i class="fas fa-check me-1"></i> Rank verified! Ready to play.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Enhanced Stats Layout -->
        <ul class="nav nav-tabs enhanced-tabs mb-4" id="statsTabsNav" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                        data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-1"></i> Overview
                </button>
            </li>
            {% if has_ranked_stats %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranked-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#ranked-stats" type="button" role="tab">
                    <i class="fas fa-trophy me-1"></i> Ranked Stats
                </button>
            </li>
            {% endif %}
            {% if has_global_stats %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="global-stats-tab" data-bs-toggle="tab"
                        data-bs-target="#global-stats" type="button" role="tab">
                    <i class="fas fa-globe me-1"></i> Global Stats
                </button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="match-history-tab" data-bs-toggle="tab"
                        data-bs-target="#match-history" type="button" role="tab">
                    <i class="fas fa-history me-1"></i> Match History
                </button>
            </li>
        </ul>

        <div class="tab-content enhanced-tab-content" id="statsTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Performance Overview Cards -->
                <div class="row mb-4">
                    {% if has_ranked_stats %}
                    <div class="col-lg-6 mb-4">
                        <div class="card bg-dark-medium h-100 border-warning border-start border-3">
                            <div class="card-header bg-dark">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 text-warning">
                                            <i class="fas fa-trophy me-2"></i> Ranked Performance
                                        </h5>
                                        <small class="text-muted">Competitive tier matches</small>
                                    </div>
                                    {% if rank_data and rank_data.tier %}
                                        {% if rank_data.tier == 'Rank A' %}
                                            <span class="badge bg-danger fs-6">{{ rank_data.tier }}</span>
                                        {% elif rank_data.tier == 'Rank B' %}
                                            <span class="badge bg-primary fs-6">{{ rank_data.tier }}</span>
                                        {% else %}
                                            <span class="badge bg-success fs-6">{{ rank_data.tier }}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- MMR Display -->
                                <div class="text-center mb-4">
                                    <div class="display-4 text-warning fw-bold mb-2">{{ player_data.mmr or 0 }}</div>
                                    <div class="text-muted">Current MMR</div>
                                </div>

                                <!-- Stats Grid -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-info mb-1">{{ player_data.matches or 0 }}</div>
                                            <small class="text-muted">Matches</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-success mb-1">{{ player_data.wins or 0 }}</div>
                                            <small class="text-muted">Wins</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-danger mb-1">{{ player_data.losses or 0 }}</div>
                                            <small class="text-muted">Losses</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Win Rate Progress -->
                                {% set win_rate = (player_data.wins / player_data.matches * 100) if player_data.matches > 0 else 0 %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="small">Win Rate</span>
                                        <span class="small fw-bold">{{ "%.1f"|format(win_rate) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ win_rate }}%" aria-valuenow="{{ win_rate }}"
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>

                                <!-- Current Streak -->
                                {% if player_data.current_streak %}
                                    <div class="text-center">
                                        {% if player_data.current_streak > 0 %}
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-fire me-1"></i> {{ player_data.current_streak }} Win Streak
                                            </span>
                                        {% elif player_data.current_streak < 0 %}
                                            <span class="badge bg-danger fs-6">
                                                <i class="fas fa-arrow-down me-1"></i> {{ abs(player_data.current_streak) }} Loss Streak
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if has_global_stats %}
                    <div class="col-lg-6 mb-4">
                        <div class="card bg-dark-medium h-100 border-primary border-start border-3">
                            <div class="card-header bg-dark">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 text-primary">
                                            <i class="fas fa-globe me-2"></i> Global Performance
                                        </h5>
                                        <small class="text-muted">Cross-rank matches</small>
                                    </div>
                                    <span class="badge bg-primary fs-6">Global</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Global MMR Display -->
                                <div class="text-center mb-4">
                                    <div class="display-4 text-primary fw-bold mb-2">{{ player_data.global_mmr or 300 }}</div>
                                    <div class="text-muted">Global MMR</div>
                                </div>

                                <!-- Global Stats Grid -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-info mb-1">{{ player_data.global_matches or 0 }}</div>
                                            <small class="text-muted">Matches</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-success mb-1">{{ player_data.global_wins or 0 }}</div>
                                            <small class="text-muted">Wins</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2">
                                            <div class="h5 text-danger mb-1">{{ player_data.global_losses or 0 }}</div>
                                            <small class="text-muted">Losses</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Global Win Rate Progress -->
                                {% set global_win_rate = (player_data.global_wins / player_data.global_matches * 100) if player_data.global_matches > 0 else 0 %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="small">Win Rate</span>
                                        <span class="small fw-bold">{{ "%.1f"|format(global_win_rate) }}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-primary" role="progressbar"
                                             style="width: {{ global_win_rate }}%" aria-valuenow="{{ global_win_rate }}"
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>

                                <!-- Global Current Streak -->
                                {% if player_data.global_current_streak %}
                                    <div class="text-center">
                                        {% if player_data.global_current_streak > 0 %}
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-fire me-1"></i> {{ player_data.global_current_streak }} Win Streak
                                            </span>
                                        {% elif player_data.global_current_streak < 0 %}
                                            <span class="badge bg-danger fs-6">
                                                <i class="fas fa-arrow-down me-1"></i> {{ abs(player_data.global_current_streak) }} Loss Streak
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Charts Section -->
                {% if (ranked_matches and ranked_matches|length > 0) or (global_matches and global_matches|length > 0) %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i> MMR Progress Over Time
                                </h5>
                                <small class="text-muted">Track your improvement across all matches</small>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="mmrChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Enhanced Career Summary Section -->
                <div class="row">
                    <!-- Recent Activity - now full width -->
                    <div class="col-12 mb-4">
                        {% if recent_matches and recent_matches|length > 0 %}
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-clock me-2"></i> Recent Activity
                                </h5>
                                <small class="text-muted">Your last {{ recent_matches|length }} matches</small>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Result</th>
                                                <th>MMR Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for match in recent_matches[:5] %}
                                            <tr>
                                                <td>{{ match.date }}</td>
                                                <td>
                                                    {% if match.is_global %}
                                                        <span class="badge bg-primary">Global</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Ranked</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.player_result == 'Win' %}
                                                        <span class="badge bg-success">Win</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Loss</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.mmr_change %}
                                                        {% if match.mmr_change > 0 %}
                                                            <span class="text-success">+{{ match.mmr_change }}</span>
                                                        {% else %}
                                                            <span class="text-danger">{{ match.mmr_change }}</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="switchToMatchHistoryTab()">
                                        <i class="fas fa-list me-1"></i> View All Matches
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Career Summary Cards in Grid Layout -->
                    <div class="col-lg-4 mb-4">
                        <!-- Overall Performance Card -->
                        <div class="card bg-dark-medium h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i> Overall Performance
                                </h5>
                            </div>
                            <div class="card-body">
                                {% set total_matches = (player_data.matches or 0) + (player_data.global_matches or 0) %}
                                {% set total_wins = (player_data.wins or 0) + (player_data.global_wins or 0) %}
                                {% set total_losses = (player_data.losses or 0) + (player_data.global_losses or 0) %}

                                <div class="summary-stat mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-gamepad text-info me-2"></i>
                                            <span>Total Matches</span>
                                        </div>
                                        <span class="fw-bold fs-5">{{ total_matches }}</span>
                                    </div>
                                </div>
                                <div class="summary-stat mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-trophy text-success me-2"></i>
                                            <span>Total Wins</span>
                                        </div>
                                        <span class="fw-bold fs-5 text-success">{{ total_wins }}</span>
                                    </div>
                                </div>
                                <div class="summary-stat mb-0">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-percentage text-primary me-2"></i>
                                            <span>Overall Win Rate</span>
                                        </div>
                                        <span class="fw-bold fs-5 text-primary">{{ "%.1f"|format((total_wins / total_matches * 100) if total_matches > 0 else 0) }}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-4">
                        <!-- Peak Performance Card -->
                        <div class="card bg-dark-medium h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-mountain me-2"></i> Peak Performance
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if has_ranked_stats %}
                                <div class="summary-stat mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                        <span class="d-flex align-items-center">
                                            <i class="fas fa-trophy me-2 text-warning"></i> Ranked MMR
                                        </span>
                                        <span class="fw-bold text-warning fs-5">{{ player_data.mmr or 0 }}</span>
                                    </div>
                                </div>
                                {% endif %}
                                {% if has_global_stats %}
                                <div class="summary-stat mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                        <span class="d-flex align-items-center">
                                            <i class="fas fa-globe me-2 text-primary"></i> Global MMR
                                        </span>
                                        <span class="fw-bold text-primary fs-5">{{ player_data.global_mmr or 300 }}</span>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Rank Display -->
                                {% if rank_data %}
                                <div class="summary-stat mb-0">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                        <span class="d-flex align-items-center">
                                            <i class="fas fa-medal me-2 text-info"></i> Current Rank
                                        </span>
                                        <span class="fw-bold">
                                            {% if rank_data.tier == 'Rank A' %}
                                                <span class="badge bg-danger">{{ rank_data.tier }}</span>
                                            {% elif rank_data.tier == 'Rank B' %}
                                                <span class="badge bg-primary">{{ rank_data.tier }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ rank_data.tier }}</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-4">
                        <!-- Best Streaks Card -->
                        <div class="card bg-dark-medium h-100">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-fire me-2"></i> Best Streaks
                                </h5>
                            </div>
                            <div class="card-body d-flex flex-column">
                                {% set ranked_best_streak = player_data.longest_win_streak or 0 %}
                                {% set global_best_streak = player_data.global_longest_win_streak or 0 %}
                                {% set best_overall_streak = ranked_best_streak if ranked_best_streak > global_best_streak else global_best_streak %}

                                {% if best_overall_streak > 0 %}
                                <div class="text-center flex-grow-1 d-flex flex-column justify-content-center">
                                    <div class="streak-display-large mb-3">
                                        <div class="display-6 text-warning fw-bold">{{ best_overall_streak }}</div>
                                        <div class="text-muted small">Longest Win Streak</div>
                                    </div>
                                    {% if ranked_best_streak > 0 and global_best_streak > 0 %}
                                    <div class="row text-center mt-auto">
                                        <div class="col-6">
                                            <div class="p-2 bg-dark rounded">
                                                <div class="small text-muted">Ranked</div>
                                                <div class="fw-bold text-warning">{{ ranked_best_streak }}</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-dark rounded">
                                                <div class="small text-muted">Global</div>
                                                <div class="fw-bold text-primary">{{ global_best_streak }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div class="text-center flex-grow-1 d-flex flex-column justify-content-center">
                                    <i class="fas fa-clock fa-3x mb-3 text-muted opacity-50"></i>
                                    <p class="small mb-0 text-muted">Start winning to track your streaks!</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranked Stats Tab -->
            {% if has_ranked_stats %}
            <div class="tab-pane fade" id="ranked-stats" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card primary">
                            <div class="stat-card-icon"><i class="fas fa-trophy"></i></div>
                            <div class="stat-card-value">{{ player_data.mmr or 0 }}</div>
                            <div class="stat-card-title">Current MMR</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card secondary">
                            <div class="stat-card-icon"><i class="fas fa-gamepad"></i></div>
                            <div class="stat-card-value">{{ player_data.matches or 0 }}</div>
                            <div class="stat-card-title">Total Matches</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card accent">
                            <div class="stat-card-icon"><i class="fas fa-percentage"></i></div>
                            <div class="stat-card-value">{{ "%.1f"|format((player_data.wins or 0) / (player_data.matches or 1) * 100) }}%</div>
                            <div class="stat-card-title">Win Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="fas fa-fire"></i></div>
                            <div class="stat-card-value">{{ player_data.current_streak or 0 }}</div>
                            <div class="stat-card-title">Current Streak</div>
                        </div>
                    </div>
                </div>

                {% if ranked_matches and ranked_matches|length > 0 %}
                <div class="card bg-dark-medium">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i> Ranked MMR History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 300px;">
                            <canvas id="rankedChart"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Global Stats Tab -->
            {% if has_global_stats %}
            <div class="tab-pane fade" id="global-stats" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card primary">
                            <div class="stat-card-icon"><i class="fas fa-globe"></i></div>
                            <div class="stat-card-value">{{ player_data.global_mmr or 300 }}</div>
                            <div class="stat-card-title">Global MMR</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card secondary">
                            <div class="stat-card-icon"><i class="fas fa-gamepad"></i></div>
                            <div class="stat-card-value">{{ player_data.global_matches or 0 }}</div>
                            <div class="stat-card-title">Global Matches</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card accent">
                            <div class="stat-card-icon"><i class="fas fa-percentage"></i></div>
                            <div class="stat-card-value">{{ "%.1f"|format((player_data.global_wins or 0) / (player_data.global_matches or 1) * 100) }}%</div>
                            <div class="stat-card-title">Win Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="fas fa-fire"></i></div>
                            <div class="stat-card-value">{{ player_data.global_current_streak or 0 }}</div>
                            <div class="stat-card-title">Current Streak</div>
                        </div>
                    </div>
                </div>

                {% if global_matches and global_matches|length > 0 %}
                <div class="card bg-dark-medium">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i> Global MMR History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 300px;">
                            <canvas id="globalChart"></canvas>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Enhanced Match History Tab -->
            <div class="tab-pane fade" id="match-history" role="tabpanel">
                <div class="row">
                    <div class="col-lg-9">
                        <!-- Match History Card -->
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div class="mb-2 mb-md-0">
                                        <h5 class="mb-1">
                                            <i class="fas fa-history me-2"></i> Complete Match History
                                        </h5>
                                        <small class="text-muted">All your matches with detailed information</small>
                                    </div>
                                    <div class="match-filters">
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="matchFilter" id="filter-all" checked>
                                            <label class="btn btn-sm btn-outline-primary" for="filter-all" onclick="filterMatches('all')">
                                                <i class="fas fa-list me-1"></i> All
                                            </label>

                                            <input type="radio" class="btn-check" name="matchFilter" id="filter-ranked">
                                            <label class="btn btn-sm btn-outline-warning" for="filter-ranked" onclick="filterMatches('ranked')">
                                                <i class="fas fa-trophy me-1"></i> Ranked
                                            </label>

                                            <input type="radio" class="btn-check" name="matchFilter" id="filter-global">
                                            <label class="btn btn-sm btn-outline-info" for="filter-global" onclick="filterMatches('global')">
                                                <i class="fas fa-globe me-1"></i> Global
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if recent_matches and recent_matches|length > 0 %}
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped enhanced-table">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-calendar me-1"></i> Date</th>
                                                <th><i class="fas fa-tag me-1"></i> Type</th>
                                                <th><i class="fas fa-trophy me-1"></i> Result</th>
                                                <th><i class="fas fa-chart-line me-1"></i> MMR Change</th>
                                                <th><i class="fas fa-fire me-1"></i> Streak</th>
                                                <th><i class="fas fa-info-circle me-1"></i> Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for match in recent_matches %}
                                            <tr class="match-row" data-type="{{ 'global' if match.is_global else 'ranked' }}">
                                                <td class="match-date-display">{{ match.date }}</td>
                                                <td>
                                                    {% if match.is_global %}
                                                        <span class="badge bg-primary rounded-pill">
                                                            <i class="fas fa-globe me-1"></i> Global
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-warning rounded-pill">
                                                            <i class="fas fa-trophy me-1"></i> Ranked
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.player_result == 'Win' %}
                                                        <span class="badge bg-success rounded-pill">
                                                            <i class="fas fa-trophy me-1"></i> Win
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-danger rounded-pill">
                                                            <i class="fas fa-times me-1"></i> Loss
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.mmr_change %}
                                                        {% if match.mmr_change > 0 %}
                                                            <span class="text-success fw-bold">
                                                                <i class="fas fa-arrow-up me-1"></i> +{{ match.mmr_change }}
                                                            </span>
                                                        {% else %}
                                                            <span class="text-danger fw-bold">
                                                                <i class="fas fa-arrow-down me-1"></i> {{ match.mmr_change }}
                                                            </span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if match.streak_display %}
                                                        <span class="streak-indicator">{{ match.streak_display }}</span>
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="showMatchDetails('{{ loop.index0 }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Match Statistics Summary -->
                                <div class="row mt-4">
                                    <div class="col-md-4">
                                        <div class="stat-summary-card">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-gamepad fa-2x text-info me-3"></i>
                                                <div>
                                                    <div class="h4 mb-0" id="totalMatchesCount">{{ recent_matches|length }}</div>
                                                    <small class="text-muted">Total Matches</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-summary-card">
                                            <div class="d-flex align-items-center">
                                                {% set match_wins = recent_matches | selectattr("player_result", "equalto", "Win") | list | length %}
                                                <i class="fas fa-trophy fa-2x text-success me-3"></i>
                                                <div>
                                                    <div class="h4 mb-0 text-success" id="totalWinsCount">{{ match_wins }}</div>
                                                    <small class="text-muted">Wins</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-summary-card">
                                            <div class="d-flex align-items-center">
                                                {% set match_losses = recent_matches | selectattr("player_result", "equalto", "Loss") | list | length %}
                                                <i class="fas fa-times fa-2x text-danger me-3"></i>
                                                <div>
                                                    <div class="h4 mb-0 text-danger" id="totalLossesCount">{{ match_losses }}</div>
                                                    <small class="text-muted">Losses</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <!-- No Match History Available -->
                                <div class="text-center py-5">
                                    <i class="fas fa-history fa-4x text-muted mb-3 empty-state-icon"></i>
                                    <h6>No Match History</h6>
                                    <p class="text-muted">Start playing to see your matches here!</p>
                                    <a href="{{ url_for('home') }}" class="btn btn-primary">
                                        <i class="fas fa-gamepad me-1"></i> Learn How to Play
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <!-- Match History Analytics -->
                        <div class="card bg-dark-medium mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i> Match Analytics
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if recent_matches and recent_matches|length > 0 %}
                                <!-- Recent Form -->
                                <div class="mb-4">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-chart-bar me-1"></i> Recent Form (Last 10)
                                    </h6>
                                    <div class="form-indicator mb-3">
                                        {% for match in recent_matches[:10] %}
                                            {% if match.player_result == 'Win' %}
                                                <span class="form-dot win" title="Win - {{ match.date }}">W</span>
                                            {% else %}
                                                <span class="form-dot loss" title="Loss - {{ match.date }}">L</span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="text-center">
                                        {% set recent_wins = recent_matches[:10] | selectattr("player_result", "equalto", "Win") | list | length %}
                                        <div class="progress mb-2" style="height: 6px;">
                                            <div class="progress-bar bg-success" style="width: {{ (recent_wins / 10 * 100) if recent_matches|length >= 10 else (recent_wins / recent_matches|length * 100) }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ recent_wins }}/{{ [10, recent_matches|length] | min }} wins</small>
                                    </div>
                                </div>

                                <!-- Type Breakdown -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-chart-donut me-1"></i> Match Types
                                    </h6>
                                    {% set ranked_matches_count = recent_matches | rejectattr("is_global") | list | length %}
                                    {% set global_matches_count = recent_matches | selectattr("is_global") | list | length %}

                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="small">
                                                <i class="fas fa-trophy text-warning me-1"></i> Ranked
                                            </span>
                                            <span class="fw-bold">{{ ranked_matches_count }}</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 4px;">
                                            <div class="progress-bar bg-warning" style="width: {{ (ranked_matches_count / recent_matches|length * 100) if recent_matches|length > 0 else 0 }}%"></div>
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="small">
                                                <i class="fas fa-globe text-primary me-1"></i> Global
                                            </span>
                                            <span class="fw-bold">{{ global_matches_count }}</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 4px;">
                                            <div class="progress-bar bg-primary" style="width: {{ (global_matches_count / recent_matches|length * 100) if recent_matches|length > 0 else 0 }}%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- MMR Trends -->
                                <div>
                                    <h6 class="text-warning mb-3">
                                        <i class="fas fa-trending-up me-1"></i> MMR Trends
                                    </h6>
                                    {% if recent_matches|length >= 2 %}
                                        {% set first_match = recent_matches[-1] %}
                                        {% set last_match = recent_matches[0] %}
                                        {% set mmr_change_total = (last_match.mmr_change or 0) %}

                                        <div class="text-center">
                                            <div class="mb-2">
                                                {% if mmr_change_total > 0 %}
                                                    <i class="fas fa-arrow-up fa-2x text-success"></i>
                                                    <div class="text-success fw-bold">Trending Up</div>
                                                {% elif mmr_change_total < 0 %}
                                                    <i class="fas fa-arrow-down fa-2x text-danger"></i>
                                                    <div class="text-danger fw-bold">Trending Down</div>
                                                {% else %}
                                                    <i class="fas fa-arrows-alt-h fa-2x text-muted"></i>
                                                    <div class="text-muted fw-bold">Stable</div>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">Based on recent performance</small>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted">
                                            <i class="fas fa-chart-line fa-2x mb-2 opacity-50"></i>
                                            <p class="small mb-0">Play more matches to see trends</p>
                                        </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-chart-pie fa-3x mb-3 opacity-50"></i>
                                    <p class="mb-0">No data available</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card bg-dark-medium">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-bolt me-2"></i> Quick Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('leaderboard') }}" class="btn btn-primary">
                                        <i class="fas fa-trophy me-2"></i> View Leaderboard
                                    </a>
                                    <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                                        <i class="fas fa-user me-2"></i> Back to Profile
                                    </a>
                                    {% if not rank_data %}
                                        <a href="{{ url_for('profile_rank_check') }}" class="btn btn-warning">
                                            <i class="fas fa-check-circle me-2"></i> Verify Rank
                                        </a>
                                    {% endif %}
                                    <button class="btn btn-outline-primary" onclick="refreshStats()">
                                        <i class="fas fa-sync-alt me-2"></i> Refresh Stats
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Match Details Modal -->
<div class="modal fade" id="matchDetailsModal" tabindex="-1" aria-labelledby="matchDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark-medium">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title" id="matchDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i> Match Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="matchDetailsContent">
                <!-- Match details will be loaded here -->
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Enhanced header layout */
.content-header {
    margin-bottom: 2rem;
}

.content-header .d-flex {
    align-items: flex-start;
}

.header-left h2 {
    margin-bottom: 0.5rem;
}

.user-indicator {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-left: 1.5rem; /* Indent the user name */
}

.user-name {
    font-weight: 500;
    color: var(--text);
}

.header-right {
    margin-left: auto;
}

/* Enhanced career summary */
.summary-section {
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.summary-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.summary-stat {
    transition: all 0.2s ease;
}

.summary-stat:hover {
    transform: translateY(-2px);
}

.summary-stat .bg-dark {
    border: 1px solid transparent;
    transition: all 0.2s ease;
}

.summary-stat:hover .bg-dark {
    border-color: var(--primary);
    background-color: rgba(0, 168, 255, 0.05) !important;
}

.streak-display-large {
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    border: 1px solid var(--border);
}

/* Enhanced match history table */
.enhanced-table {
    margin-bottom: 0;
}

.enhanced-table thead th {
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 2px solid var(--border);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
    position: sticky;
    top: 0;
    z-index: 10;
}

.enhanced-table tbody tr {
    transition: all 0.2s ease;
}

.enhanced-table tbody tr:hover {
    background: rgba(0, 168, 255, 0.1);
    transform: translateX(4px);
}

.enhanced-table td {
    padding: 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid rgba(42, 48, 60, 0.5);
}

/* Match filters enhancement */
.match-filters {
    display: flex;
    gap: 0.25rem;
}

.match-filters .btn-group {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    overflow: hidden;
}

.match-filters .btn {
    font-size: 0.8rem;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
    border: none;
}

.match-filters .btn-check:checked + .btn {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Form indicators for recent performance */
.form-indicator {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
}

.form-dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
    transition: all 0.2s ease;
    cursor: help;
}

.form-dot.win {
    background: var(--success);
    color: white;
}

.form-dot.loss {
    background: var(--danger);
    color: white;
}

.form-dot:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

/* Statistics summary cards */
.stat-summary-card {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
    transition: all 0.2s ease;
}

.stat-summary-card:hover {
    border-color: var(--primary);
    background: rgba(0, 168, 255, 0.05);
    transform: translateY(-2px);
}

/* Match details button */
.btn-outline-primary:hover {
    transform: scale(1.05);
}

/* Hidden rows animation */
.match-row {
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.match-row.hidden {
    opacity: 0;
    transform: translateX(-10px);
    pointer-events: none;
}

/* Responsive enhancements */
@media (max-width: 992px) {
    .content-header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }

    .header-right {
        margin-left: 0;
        margin-top: 1rem;
        align-self: flex-end;
    }

    .user-indicator {
        margin-left: 1rem; /* Reduce indent on smaller screens */
    }

    .match-filters {
        justify-content: center;
        margin-top: 1rem;
    }
}

@media (max-width: 768px) {
    .enhanced-table {
        font-size: 0.85rem;
    }

    .enhanced-table th,
    .enhanced-table td {
        padding: 0.5rem 0.25rem;
    }

    .form-indicator {
        gap: 0.25rem;
    }

    .form-dot {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }

    .summary-stat .d-flex {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced data loading with better error handling
console.log('Loading JavaScript data...');

// Store matches data for details modal - FIXED: Ensure data exists
const matchesData = {% if recent_matches %}{{ recent_matches | tojsonfilter | safe }}{% else %}[]{% endif %};

// Enhanced chart data and functionality - FIXED: Check if data exists before converting
const chartData = {
    ranked: {% if ranked_matches %}{{ ranked_matches | tojsonfilter | safe }}{% else %}[]{% endif %},
    global: {% if global_matches %}{{ global_matches | tojsonfilter | safe }}{% else %}[]{% endif %}
};

console.log('Loaded matchesData:', matchesData);
console.log('Loaded chartData:', chartData);

// Chart.js configuration
if (typeof Chart !== 'undefined') {
    Chart.defaults.color = '#f1f1f1';
    Chart.defaults.borderColor = '#2a303c';
} else {
    console.error('Chart.js not loaded!');
}

// FIXED: Better date parsing for charts
function createChart(ctx, type) {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not available');
        return;
    }

    const datasets = [];

    if (type === 'combined' || type === 'ranked') {
        if (chartData.ranked && chartData.ranked.length > 0) {
            datasets.push({
                label: 'Ranked MMR',
                data: chartData.ranked.map((match, index) => ({
                    x: index + 1,
                    y: match.new_mmr || match.mmr_change || 0
                })),
                borderColor: '#ffd700',
                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                tension: 0.4,
                fill: false,
                borderWidth: 3,
                pointBackgroundColor: '#ffd700',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            });
        }
    }

    if (type === 'combined' || type === 'global') {
        if (chartData.global && chartData.global.length > 0) {
            datasets.push({
                label: 'Global MMR',
                data: chartData.global.map((match, index) => ({
                    x: index + 1,
                    y: match.new_mmr || match.mmr_change || 0
                })),
                borderColor: '#00a8ff',
                backgroundColor: 'rgba(0, 168, 255, 0.1)',
                tension: 0.4,
                fill: false,
                borderWidth: 3,
                pointBackgroundColor: '#00a8ff',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            });
        }
    }

    if (datasets.length === 0) {
        console.log('No chart data available for type:', type);
        // Show a message in the chart container
        const container = ctx.parentElement;
        if (container) {
            container.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3 opacity-50"></i>
                        <p class="text-muted mb-0">No match data available for chart</p>
                    </div>
                </div>
            `;
        }
        return;
    }

    new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: datasets.length > 1,
                    position: 'top',
                    labels: {
                        color: '#f1f1f1',
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#f1f1f1',
                    bodyColor: '#f1f1f1',
                    borderColor: '#2a303c',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function(tooltipItems) {
                            return `Match ${tooltipItems[0].parsed.x}`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} MMR`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Match Number',
                        color: '#f1f1f1',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    ticks: {
                        color: '#a0a8b1',
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(42, 48, 60, 0.5)',
                        drawBorder: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'MMR',
                        color: '#f1f1f1',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    ticks: {
                        color: '#a0a8b1',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(42, 48, 60, 0.5)',
                        drawBorder: false
                    },
                    beginAtZero: false
                }
            }
        }
    });
}

// FIXED: Better match details function
function showMatchDetails(matchIndex) {
    console.log('Showing match details for index:', matchIndex);
    console.log('Available matches:', matchesData);

    if (!matchesData || matchesData.length === 0) {
        console.error('No matches data available');
        alert('No match data available');
        return;
    }

    const match = matchesData[matchIndex];
    if (!match) {
        console.error('Match not found:', matchIndex);
        alert('Match data not available');
        return;
    }

    const modal = document.getElementById('matchDetailsModal');
    const modalContent = document.getElementById('matchDetailsContent');

    if (!modal || !modalContent) {
        console.error('Modal elements not found');
        return;
    }

    // Format the date properly
    let formattedDate = match.date;
    try {
        if (match.date && typeof match.date === 'string') {
            const dateObj = new Date(match.date);
            if (!isNaN(dateObj.getTime())) {
                formattedDate = dateObj.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }
    } catch (e) {
        console.log('Date formatting error:', e);
    }

    const matchType = match.is_global ? 'Global' : 'Ranked';
    const result = match.player_result || 'Unknown';
    const mmrChange = match.mmr_change || 0;

    // Get streak information
    let streakInfo = 'No streak data';
    let streakClass = 'text-muted';

    if (match.streak !== undefined && match.streak !== null && match.streak !== 0) {
        const streakValue = Math.abs(match.streak);
        if (match.streak > 0) {
            streakInfo = `${streakValue} Win Streak`;
            streakClass = 'text-success';
            if (streakValue >= 3) {
                streakInfo = `üî• ${streakInfo}`;
            }
        } else if (match.streak < 0) {
            streakInfo = `${streakValue} Loss Streak`;
            streakClass = 'text-danger';
            if (streakValue >= 3) {
                streakInfo = `üìâ ${streakInfo}`;
            }
        }
    }

    modalContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card bg-dark border-0 mb-3">
                    <div class="card-header bg-primary">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i> Match Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Date</label>
                            <div class="fw-bold">${formattedDate}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Match Type</label>
                            <div>
                                <span class="badge bg-${match.is_global ? 'primary' : 'warning'}">
                                    <i class="fas fa-${match.is_global ? 'globe' : 'trophy'} me-1"></i> ${matchType}
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Result</label>
                            <div>
                                <span class="badge bg-${result === 'Win' ? 'success' : 'danger'} fs-6">
                                    <i class="fas fa-${result === 'Win' ? 'trophy' : 'times'} me-1"></i> ${result}
                                </span>
                            </div>
                        </div>
                        ${match.match_id ? `
                        <div class="mb-3">
                            <label class="form-label small text-muted">Match ID</label>
                            <div class="font-monospace small text-info">${match.match_id}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-dark border-0 mb-3">
                    <div class="card-header bg-success">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i> Performance Impact
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small text-muted">MMR Change</label>
                            <div class="fw-bold fs-5 ${mmrChange > 0 ? 'text-success' : mmrChange < 0 ? 'text-danger' : 'text-muted'}">
                                <i class="fas fa-arrow-${mmrChange > 0 ? 'up' : mmrChange < 0 ? 'down' : 'right'} me-1"></i>
                                ${mmrChange > 0 ? '+' : ''}${mmrChange}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Streak Status</label>
                            <div class="fw-bold ${streakClass}">${streakInfo}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Impact</label>
                            <div class="small">
                                ${result === 'Win' ?
                                    '<i class="fas fa-arrow-up text-success me-1"></i> Positive momentum!' :
                                    '<i class="fas fa-arrow-down text-danger me-1"></i> Learning opportunity'
                                }
                            </div>
                        </div>
                        ${match.new_mmr ? `
                        <div class="mb-3">
                            <label class="form-label small text-muted">New MMR</label>
                            <div class="fw-bold text-primary">${match.new_mmr}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;

    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Enhanced helper functions
function refreshStats() {
    const refreshBtns = document.querySelectorAll('[onclick="refreshStats()"]');
    refreshBtns.forEach(btn => {
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
            btn.disabled = true;
        }
    });
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

function switchToMatchHistoryTab() {
    const matchHistoryTab = document.getElementById('match-history-tab');
    const matchHistoryTabPane = document.getElementById('match-history');

    if (matchHistoryTab && matchHistoryTabPane) {
        document.querySelectorAll('#statsTabsNav .nav-link').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        matchHistoryTab.classList.add('active');
        matchHistoryTabPane.classList.add('show', 'active');
    }
}

function filterMatches(type) {
    const rows = document.querySelectorAll('.match-row');
    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
            setTimeout(() => {
                if (row.classList.contains('hidden')) {
                    row.style.display = 'none';
                }
            }, 300);
        }
    });
    updateFilteredStats(type);
}

function updateFilteredStats(type) {
    const rows = document.querySelectorAll('.match-row');
    let totalMatches = 0;
    let wins = 0;

    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            totalMatches++;
            const resultBadge = row.querySelector('.badge');
            if (resultBadge && resultBadge.textContent.includes('Win')) {
                wins++;
            }
        }
    });

    const totalMatchesEl = document.getElementById('totalMatchesCount');
    const totalWinsEl = document.getElementById('totalWinsCount');
    const totalLossesEl = document.getElementById('totalLossesCount');

    if (totalMatchesEl) totalMatchesEl.textContent = totalMatches;
    if (totalWinsEl) totalWinsEl.textContent = wins;
    if (totalLossesEl) totalLossesEl.textContent = totalMatches - wins;
}

// Chart creation
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced Profile Stats loaded');
    console.log('Chart data:', chartData);
    console.log('Matches data:', matchesData);

    // Wait for Chart.js to be fully loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Make sure Chart.js is included in the page.');
        return;
    }

    // Create charts if data exists and canvas elements exist
    const mmrCtx = document.getElementById('mmrChart');
    if (mmrCtx && (chartData.ranked.length > 0 || chartData.global.length > 0)) {
        console.log('Creating combined MMR chart');
        createChart(mmrCtx, 'combined');
    }

    const rankedCtx = document.getElementById('rankedChart');
    if (rankedCtx && chartData.ranked.length > 0) {
        console.log('Creating ranked chart');
        createChart(rankedCtx, 'ranked');
    }

    const globalCtx = document.getElementById('globalChart');
    if (globalCtx && chartData.global.length > 0) {
        console.log('Creating global chart');
        createChart(globalCtx, 'global');
    }

    // Initialize tooltips
    const tooltipElements = document.querySelectorAll('[title]');
    tooltipElements.forEach(element => {
        new bootstrap.Tooltip(element);
    });

    console.log('Profile stats initialization complete');
});

console.log('Enhanced Profile Stats JavaScript loaded successfully');
</script>
{% endblock %}