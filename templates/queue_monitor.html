<!-- Enhanced queue_monitor.html -->
{% extends "base.html" %}

{% block title %}Queue Monitor - Rocket League 6 Gents{% endblock %}

{% block content %}
<div class="content-container">
    <div class="content-header">
        <h2>Active Queues</h2>
        <div>
            <span class="me-2 text-muted" id="lastUpdated">Last updated: Just now</span>
            <button id="refreshQueues" class="btn btn-discord">
                <i class="fas fa-sync-alt me-2"></i> Refresh
            </button>
        </div>
    </div>

    <div class="row" id="queuesContainer">
        {% for channel, players in queues.items %}
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>{{ channel|replace('-', ' ')|title }} Queue</span>
                    <span class="badge bg-{% if players|length >= 6 %}success{% elif players|length > 0 %}warning{% else %}secondary{% endif %} queue-count" data-channel="{{ channel }}">
                        {{ players|length }}/6 Players
                    </span>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-{% if players|length >= 6 %}success{% elif players|length > 0 %}warning{% else %}secondary{% endif %} queue-progress"
                             role="progressbar" style="width: {{ (players|length / 6) * 100 }}%;"
                             data-channel="{{ channel }}" aria-valuenow="{{ players|length }}" aria-valuemin="0" aria-valuemax="6"></div>
                    </div>

                    <div class="queue-players" id="{{ channel }}-players">
                        {% if players %}
                        {% for player in players %}
                        <div class="queue-player mb-2 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-user me-1"></i> {{ player.name }}
                            </div>
                            <span class="badge bg-primary">{{ player.mmr|default('MMR N/A') }}</span>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-center text-muted my-4">No players in queue</p>
                        {% endif %}
                    </div>

                    {% if players|length >= 6 %}
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle me-2"></i> Queue is full! Match starting soon.
                    </div>
                    {% elif players|length > 0 %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i> Waiting for {{ 6 - players|length }} more players.
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Channel: #{{ channel }}</small>
                        {% if discord_user and discord_user.in_server %}
                        <a href="discord://discord.com/channels/{{ discord_guild_id }}/{{ channel_ids[channel] }}" class="btn btn-sm btn-outline-primary">
                            <i class="fab fa-discord me-1"></i> Go to Channel
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <i class="fas fa-info-circle me-2"></i> About Queue Monitoring
        </div>
        <div class="card-body">
            <p>This page shows the current status of all active queues in the 6 Gents Discord server. Data is refreshed automatically every 30 seconds.</p>

            <h5 class="mt-3">Queue Status Colors</h5>
            <ul class="list-unstyled">
                <li><span class="badge bg-success me-2">Green</span> Queue is full, match is starting soon</li>
                <li><span class="badge bg-warning me-2">Yellow</span> Queue has players, but needs more to start</li>
                <li><span class="badge bg-secondary me-2">Gray</span> Queue is empty</li>
            </ul>

            <div class="alert alert-info mt-3">
                <i class="fas fa-lightbulb me-2"></i> <strong>Tip:</strong> You can join a queue by using the <code>/queue</code> command in the corresponding Discord channel.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let lastUpdateTime = new Date();
    const updateInterval = 30000; // 30 seconds
    let countdownInterval;
    let isAutoRefreshEnabled = true;

    // Function to update the "last updated" text
    function updateLastUpdatedText() {
        const now = new Date();
        const diff = Math.floor((now - lastUpdateTime) / 1000); // difference in seconds

        let timeText;
        if (diff < 5) {
            timeText = "Just now";
        } else if (diff < 60) {
            timeText = `${diff} seconds ago`;
        } else if (diff < 3600) {
            const minutes = Math.floor(diff / 60);
            timeText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            timeText = `${Math.floor(diff / 3600)} hour${Math.floor(diff / 3600) > 1 ? 's' : ''} ago`;
        }

        document.getElementById('lastUpdated').textContent = `Last updated: ${timeText}`;
    }

    // Function to refresh queue data
    function refreshQueueData() {
        fetch('/api/queue-status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    lastUpdateTime = new Date();
                    updateLastUpdatedText();

                    const queueData = data.data;

                    // Update each queue's status
                    for (const channel in queueData) {
                        const channelData = queueData[channel];

                        // Update count badge
                        const countElement = document.querySelector(`.queue-count[data-channel="${channel}"]`);
                        if (countElement) {
                            countElement.textContent = `${channelData.count}/6 Players`;

                            // Update badge color based on status
                            countElement.className = countElement.className.replace(/bg-\w+/, '');
                            if (channelData.status === 'full') {
                                countElement.classList.add('bg-success');
                            } else if (channelData.status === 'waiting') {
                                countElement.classList.add('bg-warning');
                            } else {
                                countElement.classList.add('bg-secondary');
                            }
                        }

                        // Update progress bar
                        const progressElement = document.querySelector(`.queue-progress[data-channel="${channel}"]`);
                        if (progressElement) {
                            progressElement.style.width = `${channelData.percent}%`;
                            progressElement.setAttribute('aria-valuenow', channelData.count);

                            // Update progress bar color
                            progressElement.className = progressElement.className.replace(/bg-\w+/, '');
                            if (channelData.status === 'full') {
                                progressElement.classList.add('bg-success');
                            } else if (channelData.status === 'waiting') {
                                progressElement.classList.add('bg-warning');
                            } else {
                                progressElement.classList.add('bg-secondary');
                            }
                        }

                        // Update players list (this would need an additional API endpoint that returns player details)
                        // This is simplified - you'd need to implement a separate endpoint for this
                        const playersElement = document.getElementById(`${channel}-players`);
                        if (playersElement && channelData.players) {
                            let playersHtml = '';

                            if (channelData.players.length > 0) {
                                channelData.players.forEach(player => {
                                    playersHtml += `
                                        <div class="queue-player mb-2 d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-user me-1"></i> ${player.name}
                                            </div>
                                            <span class="badge bg-primary">${player.mmr || 'MMR N/A'}</span>
                                        </div>
                                    `;
                                });
                            } else {
                                playersHtml = '<p class="text-center text-muted my-4">No players in queue</p>';
                            }

                            playersElement.innerHTML = playersHtml;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error refreshing queue data:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Set up refresh button
        document.getElementById('refreshQueues').addEventListener('click', function() {
            refreshQueueData();
        });

        // Initialize last updated text
        updateLastUpdatedText();

        // Update the "last updated" text every 5 seconds
        setInterval(updateLastUpdatedText, 5000);

        // Set up auto-refresh
        countdownInterval = setInterval(function() {
            if (isAutoRefreshEnabled) {
                refreshQueueData();
            }
        }, updateInterval);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        clearInterval(countdownInterval);
    });
</script>
{% endblock %}